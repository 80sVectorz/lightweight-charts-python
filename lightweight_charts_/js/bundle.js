var Lib=function(e,t){"use strict";function i(e){if(void 0===e)throw new Error("Value is undefined");return e}class o{_chart=void 0;_series=void 0;requestUpdate(){this._requestUpdate&&this._requestUpdate()}_requestUpdate;attached({chart:e,series:t,requestUpdate:i}){this._chart=e,this._series=t,this._series.subscribeDataChanged(this._fireDataUpdated),this._requestUpdate=i,this.requestUpdate()}detached(){this._chart=void 0,this._series=void 0,this._requestUpdate=void 0}get chart(){return i(this._chart)}get series(){return i(this._series)}_fireDataUpdated(e){this.dataUpdated&&this.dataUpdated(e)}}function s(e,t){if(e.startsWith("#"))return function(e,t){if(e=e.replace(/^#/,""),!/^([0-9A-F]{3}){1,2}$/i.test(e))throw new Error("Invalid hex color format.");const[i,o,s]=(e=>3===e.length?[parseInt(e[0]+e[0],16),parseInt(e[1]+e[1],16),parseInt(e[2]+e[2],16)]:[parseInt(e.slice(0,2),16),parseInt(e.slice(2,4),16),parseInt(e.slice(4,6),16)])(e);return`rgba(${i}, ${o}, ${s}, ${t})`}(e,t);if(e.startsWith("rgba")||e.startsWith("rgb"))return e.replace(/rgba?\((\d+),\s*(\d+),\s*(\d+)(?:,\s*[\d.]+)?\)/,`rgba($1, $2, $3, ${t})`);throw new Error("Unsupported color format. Use hex, rgb, or rgba.")}class n{numbers;cache;constructor(e){this.numbers=e,this.cache=new Map}findClosestIndex(e,t){const i=`${e}:${t}`;if(this.cache.has(i))return this.cache.get(i);const o=this._performSearch(e,t);return this.cache.set(i,o),o}_performSearch(e,t){let i=0,o=this.numbers.length-1;if(e<=this.numbers[0].time)return 0;if(e>=this.numbers[o].time)return o;for(;i<=o;){const t=Math.floor((i+o)/2),s=this.numbers[t].time;if(s===e)return t;s>e?o=t-1:i=t+1}return"left"===t?i:o}}function r(e,t){if(e._isDecorated)return console.warn("Series is already decorated. Skipping decoration."),e;e._isDecorated=!0;const i=[],o=e.setData.bind(e),s=[];let n=null;const r=e.detachPrimitive?.bind(e),a=e.attachPrimitive?.bind(e);function l(i){const o=s.indexOf(i);if(-1!==o&&(s.splice(o,1),n===i&&(n=null),r&&r(i),t)){t.findLegendPrimitive(e,i)&&(t.removeLegendPrimitive(i),console.log(`Removed primitive of type "${i.constructor.name}" from legend.`))}}function c(){for(console.log("Detaching all primitives.");s.length>0;){l(s.pop())}console.log("All primitives detached.")}return Object.assign(e,{setData:function(e){o(e);for(const t of i)t.setData(e);console.log("Data updated on series and peers.")},addPeer:function(e){i.push(e)},removePeer:function(e){const t=i.indexOf(e);-1!==t&&i.splice(t,1)},peers:i,primitives:s,attachPrimitive:function(i,o,r=!0,d=!1){const h=i.constructor.type||i.constructor.name;if(r)c();else{const e=s.findIndex((e=>e.constructor.type===h));-1!==e&&l(s[e])}a&&a(i),s.push(i),n=i,console.log(`Primitive of type "${h}" attached.`),t&&d&&t.addLegendPrimitive(e,i,o)},detachPrimitive:l,detachPrimitives:c,decorated:!0,get primitive(){return n}})}function a(e){const t=e.options();return"lineColor"in t||"color"in t}function l(e,t){return(e=>void 0!==e.primitives)(e)?e:(console.log("Decorating the series dynamically."),r(e,t))}class c extends o{static type="Fill Area";_paneViews;_originSeries;_destinationSeries;_bandsData=[];options;_timeIndices;constructor(e,t,i){super();const o="#0000FF",r="#FF0000",l=a(e)?s(e.options().lineColor||e.options().color||o,.3):s(o,.3),c=a(t)?s(t.options().lineColor||t.options().color||r,.3):s(r,.3);this.options={...p,...i,originColor:i.originColor??l,destinationColor:i.destinationColor??c},this._paneViews=[new h(this)],this._timeIndices=new n([]),this._originSeries=e,this._destinationSeries=t}updateAllViews(){this._paneViews.forEach((e=>e.update()))}applyOptions(e){const t="#0000FF",i="#FF0000",o=a(this._originSeries)?s(this._originSeries.options().lineColor||this._originSeries.options().color||t,.3):s(t,.3),n=a(this._destinationSeries)?s(this._destinationSeries.options().lineColor||this._destinationSeries.options().color||i,.3):s(i,.3);this.options={...this.options,...e,originColor:e.originColor||o,destinationColor:e.destinationColor||n},this.calculateBands(),this.updateAllViews(),super.requestUpdate(),console.log("FillArea options updated:",this.options)}paneViews(){return this._paneViews}attached(e){super.attached(e),this.dataUpdated("full")}dataUpdated(e){if(this.calculateBands(),"full"===e){const e=this._originSeries.data();this._timeIndices=new n([...e])}}calculateBands(){const e=this._originSeries.data(),t=this._destinationSeries.data(),i=this._alignDataLengths([...e],[...t]),o=[];for(let e=0;e<i.origin.length;e++){let t=u(i.origin[e],i.destination[e]);if(void 0===t?.originValue||void 0===t?.destinationValue)continue;const s=Math.max(t?.originValue,t?.destinationValue),n=Math.min(t?.originValue,t?.destinationValue);o.push({time:i.origin[e].time,origin:t?.originValue,destination:t?.destinationValue,upper:s,lower:n})}this._bandsData=o}_alignDataLengths(e,t){const i=e.length,o=t.length;if(i>o){const e=t[o-1];for(;t.length<i;)t.push({...e})}else if(o>i){const t=e[i-1];for(;e.length<o;)e.push({...t})}return{origin:e,destination:t}}autoscaleInfo(e,t){const i=this.chart.timeScale(),o=i.coordinateToTime(i.logicalToCoordinate(e)??0)??0,s=i.coordinateToTime(i.logicalToCoordinate(t)??5e9)??5e9,n=this._timeIndices.findClosestIndex(o,"left"),r=this._timeIndices.findClosestIndex(s,"right"),a={minValue:Math.min(...this._bandsData.map((e=>e.lower)).slice(n,r+1)),maxValue:Math.max(...this._bandsData.map((e=>e.upper)).slice(n,r+1))};return{priceRange:{minValue:a.minValue,maxValue:a.maxValue}}}}class d{_viewData;_options;constructor(e){this._viewData=e,this._options=e.options}draw(){}drawBackground(e){const t=this._viewData.data,i=this._options;t.length<2||e.useBitmapCoordinateSpace((e=>{const o=e.context;o.scale(e.horizontalPixelRatio,e.verticalPixelRatio);let s=!1,n=0;for(let e=0;e<t.length-1;e++){const r=t[e],a=t[e+1];if(!s||r.isOriginAbove!==t[e-1]?.isOriginAbove){if(s){for(let i=e-1;i>=n;i--)o.lineTo(t[i].x,t[i].destination);o.closePath(),o.fill()}o.beginPath(),o.moveTo(r.x,r.origin),o.fillStyle=r.isOriginAbove?i.originColor||"rgba(0, 0, 0, 0)":i.destinationColor||"rgba(0, 0, 0, 0)",n=e,s=!0}if(o.lineTo(a.x,a.origin),e===t.length-2||a.isOriginAbove!==r.isOriginAbove){for(let i=e+1;i>=n;i--)o.lineTo(t[i].x,t[i].destination);o.closePath(),o.fill(),s=!1}}i.lineWidth&&(o.lineWidth=i.lineWidth,o.strokeStyle=i.originColor||"rgba(0, 0, 0, 0)",o.stroke())}))}}class h{_source;_data;constructor(e){this._source=e,this._data={data:[],options:this._source.options}}update(){const e=this._source.chart.timeScale();this._data.data=this._source._bandsData.map((t=>({x:e.timeToCoordinate(t.time),origin:this._source._originSeries.priceToCoordinate(t.origin),destination:this._source._destinationSeries.priceToCoordinate(t.destination),isOriginAbove:t.origin>t.destination}))),this._data.options=this._source.options}renderer(){return new d(this._data)}}const p={originColor:null,destinationColor:null,lineWidth:null};function u(e,t){let i,o;if(void 0!==e.close){i=e.close}else void 0!==e.value&&(i=e.value);if(void 0!==t.close){o=t.close}else void 0!==t.value&&(o=t.value);if(void 0!==i&&void 0!==o){if(i<o){return{originValue:void 0!==e.close?Math.min(e.open,e.close):i,destinationValue:void 0!==t.close?Math.max(t.open,t.close):o}}return{originValue:void 0!==e.close?Math.max(e.open,e.close):i,destinationValue:void 0!==t.close?Math.min(t.open,t.close):o}}}const m={backgroundColor:"#0c0d0f",hoverBackgroundColor:"#3c434c",clickBackgroundColor:"#50565E",activeBackgroundColor:"rgba(0, 122, 255, 0.7)",mutedBackgroundColor:"rgba(0, 122, 255, 0.3)",borderColor:"#3C434C",color:"#d8d9db",activeColor:"#ececed"};function g(){window.pane={...m},window.containerDiv=document.getElementById("container")||document.createElement("div"),window.setCursor=e=>{e&&(window.cursor=e),document.body.style.cursor=window.cursor},window.cursor="default",window.textBoxFocused=!1}const _='\n<svg xmlns="http://www.w3.org/2000/svg" width="22" height="16" viewBox="0 0 24 24">\n    <path style="fill:none;stroke-width:2;stroke-linecap:round;stroke-linejoin:round;stroke:#FFF;stroke-opacity:1;stroke-miterlimit:4;" \n          d="M 21.998437 12 C 21.998437 12 18.998437 18 12 18 \n             C 5.001562 18 2.001562 12 2.001562 12 \n             C 2.001562 12 5.001562 6 12 6 \n             C 18.998437 6 21.998437 12 21.998437 12 Z" />\n    <path style="fill:none;stroke-width:2;stroke-linecap:round;stroke-linejoin:round;stroke:#FFF;stroke-opacity:1;stroke-miterlimit:4;" \n          d="M 15 12 \n             C 15 13.654687 13.654687 15 12 15 \n             C 10.345312 15 9 13.654687 9 12 \n             C 9 10.345312 10.345312 9 12 9 \n             C 13.654687 9 15 10.345312 15 12 Z" />\n</svg>\n',y='\n<svg xmlns="http://www.w3.org/2000/svg" width="22" height="16" viewBox="0 0 24 24">\n <path style="fill:none;stroke-width:2;stroke-linecap:round;stroke-linejoin:round;stroke:#FFF;stroke-opacity:1;stroke-miterlimit:4;" \n          d="M 3 3 L 21 21" />\n    <path style="fill:none;stroke-width:2;stroke-linecap:round;stroke-linejoin:round;stroke:#FFF;stroke-opacity:1;stroke-miterlimit:4;" \n          d="M 21.998437 12 \n             C 21.998437 12 18.998437 18 12 18 \n             C 5.001562 18 2.001562 12 2.001562 12 \n             C 2.001562 12 5.001562 6 12 6 \n             C 14.211 6 16.106 6.897 17.7 8.1" />\n    <path style="fill:none;stroke-width:2;stroke-linecap:round;stroke-linejoin:round;stroke:#FFF;stroke-opacity:1;stroke-miterlimit:4;" \n          d="M 9.9 9.9 \n             C 9.367 10.434 9 11.178 9 12 \n             C 9 13.654687 10.345312 15 12 15 \n             C 12.822 15 13.566 14.633 14.1 14.1" />\n</svg>\n',v=new Map;function b(e){return v.get(e)||null}class f{handler;div;seriesContainer;ohlcEnabled=!1;percentEnabled=!1;linesEnabled=!1;colorBasedOnCandle=!1;text;candle;_items=[];_lines=[];_groups=[];constructor(e){this.handler=e,this.div=document.createElement("div"),this.div.classList.add("legend"),this.seriesContainer=document.createElement("div"),this.text=document.createElement("span"),this.candle=document.createElement("div"),this.setupLegend(),this.legendHandler=this.legendHandler.bind(this),e.chart.subscribeCrosshairMove(this.legendHandler)}setupLegend(){this.div.style.maxWidth=100*this.handler.scale.width-8+"vw",this.div.style.display="none";const e=document.createElement("div");e.style.display="flex",e.style.flexDirection="row",this.seriesContainer.classList.add("series-container"),this.text.style.lineHeight="1.8",e.appendChild(this.seriesContainer),this.div.appendChild(this.text),this.div.appendChild(this.candle),this.div.appendChild(e),this.handler.div.appendChild(this.div)}legendItemFormat(e,t){return"number"!=typeof e||isNaN(e)?"-":e.toFixed(t).toString().padStart(8," ")}shorthandFormat(e){const t=Math.abs(e);return t>=1e6?(e/1e6).toFixed(1)+"M":t>=1e3?(e/1e3).toFixed(1)+"K":e.toString().padStart(8," ")}createSvgIcon(e){const t=document.createElement("div");t.innerHTML=e.trim();return t.querySelector("svg")}addLegendItem(e){const t=this.mapToSeries(e);if(t.group)return this.addItemToGroup(t,t.group);{const e=this.makeSeriesRow(t,this.seriesContainer);return this._lines.push(t),this._items.push(t),e}}addLegendPrimitive(e,t,i){const o=i||t.constructor.name,s=this._lines.find((t=>t.series===e));if(!s)return void console.warn(`Parent series not found in legend for primitive: ${o}`);let n=this.seriesContainer.querySelector(`[data-series-id="${s.name}"] .primitives-container`);n||(n=document.createElement("div"),n.classList.add("primitives-container"),n.style.display="none",n.style.marginLeft="20px",n.style.flexDirection="column",s.row.insertAdjacentElement("afterend",n));const r=Array.from(n.children).find((e=>e.getAttribute("data-primitive-type")===o));if(r)return console.warn(`Primitive "${o}" already exists under the parent series.`),r;const a=document.createElement("div");a.classList.add("legend-primitive-row"),a.setAttribute("data-primitive-type",o),a.style.display="flex",a.style.justifyContent="space-between",a.style.marginTop="4px";const l=document.createElement("span");l.innerText=o;const c=document.createElement("div");c.style.cursor="pointer",c.style.display="flex",c.style.alignItems="center";const d=this.createSvgIcon(_),h=this.createSvgIcon(y);c.appendChild(d.cloneNode(!0));let p=!0;return c.addEventListener("click",(()=>{p=!p,c.innerHTML="",c.appendChild(p?d.cloneNode(!0):h.cloneNode(!0)),this.togglePrimitive(t,p)})),a.appendChild(l),a.appendChild(c),n.appendChild(a),n.children.length>0&&(n.style.display="block"),a}togglePrimitive(e,t){const i=e.options;if(!i)return void console.warn("Primitive has no options to update.");const o="_originalColors";e[o]||(e[o]={});const s=e[o],n={};for(const e of Object.keys(i))e.toLowerCase().includes("color")&&(t?n[e]=s[e]||i[e]:(s[e]||(s[e]=i[e]),n[e]="rgba(0,0,0,0)"));Object.keys(n).length>0&&(console.log(`Updating visibility for primitive: ${e.constructor.name}`),e.applyOptions(n),t&&delete e[o])}findLegendPrimitive(e,t){const i=this._lines.find((t=>t.series===e))?.row;if(!i)return null;const o=i.querySelector(".primitives-container");if(!o)return null;const s=t.constructor.type||t.constructor.name;return Array.from(o.children).find((e=>e.getAttribute("data-primitive-type")===s))}removeLegendPrimitive(e){const t=e.constructor.type||e.constructor.name;console.log(`Removing legend entry for primitive: ${t}`);const i=Array.from(this.seriesContainer.children);for(const e of i)if(e.textContent?.includes(`Primitive: ${t}`)){this.seriesContainer.removeChild(e),console.log(`Legend entry for primitive "${t}" removed.`);break}}mapToSeries(e){return{name:e.name,series:e.series,group:e.group||void 0,legendSymbol:e.legendSymbol||[],colors:e.colors||["#000"],seriesType:e.seriesType||"Line",div:document.createElement("div"),row:document.createElement("div"),toggle:document.createElement("div"),extraData:e.extraData||null}}addItemToGroup(e,t){let i=this._groups.find((e=>e.name===t));return i?(i.seriesList.push(e),this.makeSeriesRow(e,i.div),i.row):this.makeSeriesGroup(t,[e])}makeSeriesGroup(e,t){let i=this._groups.find((t=>t.name===e));if(i)return i.seriesList.push(...t),t.forEach((e=>this.makeSeriesRow(e,i.div))),i.row;{const i={name:e,seriesList:t,subGroups:[],div:document.createElement("div"),row:document.createElement("div"),toggle:document.createElement("div")};return this._groups.push(i),this.renderGroup(i,this.seriesContainer),i.row}}makeSeriesRow(e,t){const i=document.createElement("div");i.classList.add("legend-series-row"),i.style.display="flex",i.style.alignItems="center",i.style.justifyContent="space-between",i.style.marginBottom="4px";const o=document.createElement("div");o.classList.add("series-info"),o.style.flex="1";if(["Bar","Candlestick"].includes(e.seriesType||"")){const t="-",i="-",s=e.legendSymbol[0]||"▨",n=e.legendSymbol[1]||s,r=e.colors[0]||"#00FF00",a=e.colors[1]||"#FF0000";o.innerHTML=`\n                <span style="color: ${r};">${s}</span>\n                <span style="color: ${a};">${n}</span>\n                ${e.name}: <span style="color: ${a};">O ${t}</span>, \n                <span style="color: ${r};">C ${i}</span>\n            `}else o.innerHTML=e.legendSymbol.map(((t,i)=>`<span style="color: ${e.colors[i]||e.colors[0]};">${t}</span>`)).join(" ")+` ${e.name}`;const s=document.createElement("div");s.classList.add("legend-toggle-switch"),s.style.cursor="pointer",s.style.display="flex",s.style.alignItems="center";const n=this.createSvgIcon(_),r=this.createSvgIcon(y);s.appendChild(n.cloneNode(!0));let a=!0;s.addEventListener("click",(t=>{a=!a,e.series.applyOptions({visible:a}),s.innerHTML="",s.appendChild(a?n.cloneNode(!0):r.cloneNode(!0)),s.setAttribute("aria-pressed",a.toString()),s.classList.toggle("inactive",!a),t.stopPropagation()})),s.setAttribute("role","button"),s.setAttribute("aria-label",`Toggle visibility for ${e.name}`),s.setAttribute("aria-pressed",a.toString()),i.appendChild(o),i.appendChild(s),t.appendChild(i),i.addEventListener("contextmenu",(e=>{e.preventDefault()}));const l={...e,div:o,row:i,toggle:s};return this._lines.push(l),i}deleteLegendEntry(e,t){if(t&&!e){const e=this._groups.findIndex((e=>e.name===t));if(-1!==e){const i=this._groups[e];this.seriesContainer.removeChild(i.row),this._groups.splice(e,1),this._items=this._items.filter((e=>e!==i)),console.log(`Group "${t}" removed.`)}else console.warn(`Legend group with name "${t}" not found.`)}else if(e){let i=!1;if(t){const o=this._groups.find((e=>e.name===t));if(o){const s=o.seriesList.findIndex((t=>t.name===e));-1!==s&&(o.seriesList.splice(s,1),0===o.seriesList.length?(this.seriesContainer.removeChild(o.row),this._groups=this._groups.filter((e=>e!==o)),this._items=this._items.filter((e=>e!==o)),console.log(`Group "${t}" is empty and has been removed.`)):this.renderGroup(o,this.seriesContainer),i=!0,console.log(`Series "${e}" removed from group "${t}".`))}else console.warn(`Legend group with name "${t}" not found.`)}if(!i){const t=this._lines.findIndex((t=>t.name===e));if(-1!==t){const o=this._lines[t];this.seriesContainer.removeChild(o.row),this._lines.splice(t,1),this._items=this._items.filter((e=>e!==o)),i=!0,console.log(`Series "${e}" removed.`)}}i||console.warn(`Legend item with name "${e}" not found.`)}else console.warn("No seriesName or groupName provided for deletion.")}getGroupOfSeries(e){for(const t of this._groups){const i=this.findGroupOfSeriesRecursive(t,e);if(i)return i}}findGroupOfSeriesRecursive(e,t){for(const i of e.seriesList)if(i.series===t)return e.name;for(const i of e.subGroups){const e=this.findGroupOfSeriesRecursive(i,t);if(e)return e}}moveSeriesToGroup(e,t){let i=this._lines.findIndex((t=>t.name===e)),o=null;if(-1!==i)o=this._lines[i];else for(const t of this._groups){const i=t.seriesList.findIndex((t=>t.name===e));if(-1!==i){o=t.seriesList[i],t.seriesList.splice(i,1),0===t.seriesList.length?(this.seriesContainer.removeChild(t.row),this._groups=this._groups.filter((e=>e!==t)),this._items=this._items.filter((e=>e!==t)),console.log(`Group "${t.name}" is empty and has been removed.`)):this.renderGroup(t,this.seriesContainer);break}}if(!o)return void console.warn(`Series "${e}" not found in legend.`);-1!==i?(this.seriesContainer.removeChild(o.row),this._lines.splice(i,1),this._items=this._items.filter((e=>e!==o))):this._items=this._items.filter((e=>e!==o));let s=this.findGroup(t);s?(s.seriesList.push(o),this.makeSeriesRow(o,s.div)):(s={name:t,seriesList:[o],subGroups:[],div:document.createElement("div"),row:document.createElement("div"),toggle:document.createElement("div")},this._groups.push(s),this.renderGroup(s,this.seriesContainer)),this._items.push(o),console.log(`Series "${e}" moved to group "${t}".`)}renderGroup(e,t){e.row.innerHTML="",e.row.style.display="flex",e.row.style.flexDirection="column",e.row.style.width="100%";const i=document.createElement("div");i.classList.add("group-header"),i.style.display="flex",i.style.alignItems="center",i.style.justifyContent="space-between",i.style.cursor="pointer";const o=document.createElement("span");o.style.fontWeight="bold",o.innerHTML=e.seriesList.map((e=>e.legendSymbol.map(((t,i)=>`<span style="color: ${e.colors[i]||e.colors[0]};">${t}</span>`)).join(" "))).join(" ")+` ${e.name}`;const s=document.createElement("span");s.classList.add("toggle-button"),s.style.marginLeft="auto",s.style.fontSize="1.2em",s.style.cursor="pointer",s.innerHTML="⌲",s.setAttribute("aria-expanded","true"),s.addEventListener("click",(t=>{t.stopPropagation(),"none"===e.div.style.display?(e.div.style.display="block",s.innerHTML="⌲",s.setAttribute("aria-expanded","true")):(e.div.style.display="none",s.innerHTML="☰",s.setAttribute("aria-expanded","false"))})),i.appendChild(o),i.appendChild(s),e.row.appendChild(i),e.div=document.createElement("div"),e.div.style.display="block",e.div.style.marginLeft="10px";for(const t of e.seriesList)this.makeSeriesRow(t,e.div);for(const t of e.subGroups){const i=document.createElement("div");i.style.display="flex",i.style.flexDirection="column",i.style.paddingLeft="5px",this.renderGroup(t,i),e.div.appendChild(i)}e.row.appendChild(e.div),t.contains(e.row)||t.appendChild(e.row),e.row.oncontextmenu=e=>{e.preventDefault()}}legendHandler(e,t=!1){if(!this.ohlcEnabled&&!this.linesEnabled&&!this.percentEnabled)return;const i=this.handler.series.options();if(!e.time)return this.candle.style.color="transparent",void(this.candle.innerHTML=this.candle.innerHTML.replace(i.upColor,"").replace(i.downColor,""));let o,s=null;if(t){const t=this.handler.chart.timeScale();let i=t.timeToCoordinate(e.time);i&&(s=t.coordinateToLogical(i.valueOf())),s&&(o=this.handler.series.dataByIndex(s.valueOf()))}else o=e.seriesData.get(this.handler.series);this.candle.style.color="";let n='<span style="line-height: 1.8;">';if(o&&(this.ohlcEnabled&&(n+=`O ${this.legendItemFormat(o.open,this.handler.precision)} `,n+=`| H ${this.legendItemFormat(o.high,this.handler.precision)} `,n+=`| L ${this.legendItemFormat(o.low,this.handler.precision)} `,n+=`| C ${this.legendItemFormat(o.close,this.handler.precision)} `),this.percentEnabled)){const e=(o.close-o.open)/o.open*100,t=e>0?i.upColor:i.downColor,s=`${e>=0?"+":""}${e.toFixed(2)} %`;n+=this.colorBasedOnCandle?`| <span style="color: ${t};">${s}</span>`:`| ${s}`}this.candle.innerHTML=n+"</span>",this.updateGroupDisplay(e,s,t),this.updateSeriesDisplay(e,s,t)}updateSeriesDisplay(e,t,i){this._lines&&this._lines.length?this._lines.forEach((t=>{const i=e.seriesData.get(t.series)||b(t.series);if(!i)return void(t.div.innerHTML=`${t.name}: -`);const o=t.seriesType||"Line",s=t.series.options().priceFormat;if("Line"===o||"Area"===o){const e=i;if(null==e.value)return void(t.div.innerHTML=`${t.name}: -`);const o=this.legendItemFormat(e.value,s.precision);t.div.innerHTML=`\n                    <span style="color: ${t.colors[0]};">${t.legendSymbol[0]||"▨"}</span> \n                    ${t.name}: ${o}`}else if("Bar"===o||"customCandle"===o||"htfCandle"===o){const{open:e,close:o}=i;if(null==e||null==o)return void(t.div.innerHTML=`${t.name}: -`);const n=this.legendItemFormat(e,s.precision),r=this.legendItemFormat(o,s.precision),a=o>e,l=a?t.colors[0]:t.colors[1],c=a?t.legendSymbol[0]:t.legendSymbol[1];t.div.innerHTML=`\n                    <span style="color: ${l};">${c||"▨"}</span>\n                    ${t.name}: \n                    <span style="color: ${l};">O ${n}</span>, \n                    <span style="color: ${l};">C ${r}</span>`}})):console.error("No lines available to update legend.")}updateGroupDisplay(e,t,i){this._groups.forEach((t=>{this.linesEnabled?(t.row.style.display="flex",t.seriesList.forEach((t=>{const i=e.seriesData.get(t.series)||b(t.series);if(!i)return void(t.div.innerHTML=`${t.name}: -`);const o=t.seriesType||"Line",s=t.name,n=t.series.options().priceFormat;if(["Bar","customCandle","htfCandle"].includes(o)){const{open:e,close:o,high:r,low:a}=i;if(null==e||null==o||null==r||null==a)return void(t.div.innerHTML=`${s}: -`);const l=this.legendItemFormat(e,n.precision),c=this.legendItemFormat(o,n.precision),d=o>e,h=d?t.colors[0]:t.colors[1],p=d?t.legendSymbol[0]:t.legendSymbol[1];t.div.innerHTML=`\n                        <span style="color: ${h};">${p||"▨"}</span>\n                        ${s}: \n                        <span style="color: ${h};">O ${l}</span>, \n                        <span style="color: ${h};">C ${c}</span>\n                    `}else{const e="value"in i?i.value:void 0;if(null==e)return void(t.div.innerHTML=`${s}: -`);const o=this.legendItemFormat(e,n.precision),r=t.colors[0],a=t.legendSymbol[0]||"▨";t.div.innerHTML=`\n                        <span style="color: ${r};">${a}</span>\n                        ${s}: ${o}\n                    `}}))):t.row.style.display="none"}))}findGroup(e,t=this._groups){for(const i of t){if(i.name===e)return i;const t=this.findGroup(e,i.subGroups);if(t)return t}}}const w={lineColor:"#1E80F0",lineStyle:t.LineStyle.Solid,width:4};var C;!function(e){e[e.NONE=0]="NONE",e[e.HOVERING=1]="HOVERING",e[e.DRAGGING=2]="DRAGGING",e[e.DRAGGINGP1=3]="DRAGGINGP1",e[e.DRAGGINGP2=4]="DRAGGINGP2",e[e.DRAGGINGP3=5]="DRAGGINGP3",e[e.DRAGGINGP4=6]="DRAGGINGP4"}(C||(C={}));class x extends o{_paneViews=[];_options;_points=[];_state=C.NONE;_startDragPoint=null;_latestHoverPoint=null;static _mouseIsDown=!1;static hoveredObject=null;static lastHoveredObject=null;_listeners=[];constructor(e){super(),this._options={...w,...e}}updateAllViews(){this._paneViews.forEach((e=>e.update()))}paneViews(){return this._paneViews}applyOptions(e){this._options={...this._options,...e},this.requestUpdate()}updatePoints(...e){for(let t=0;t<this.points.length;t++)null!=e[t]&&(this.points[t]=e[t]);this.requestUpdate()}detach(){this._options.lineColor="transparent",this.requestUpdate(),this.series.detachPrimitive(this);for(const e of this._listeners)document.body.removeEventListener(e.name,e.listener)}get points(){return this._points}_subscribe(e,t){document.body.addEventListener(e,t),this._listeners.push({name:e,listener:t})}_unsubscribe(e,t){document.body.removeEventListener(e,t);const i=this._listeners.find((i=>i.name===e&&i.listener===t));this._listeners.splice(this._listeners.indexOf(i),1)}_handleHoverInteraction(e){if(this._latestHoverPoint=e.point,x._mouseIsDown)this._handleDragInteraction(e);else if(this._mouseIsOverDrawing(e)){if(this._state!=C.NONE)return;this._moveToState(C.HOVERING),x.hoveredObject=x.lastHoveredObject=this}else{if(this._state==C.NONE)return;this._moveToState(C.NONE),x.hoveredObject===this&&(x.hoveredObject=null)}}static _eventToPoint(e,t){if(!t||!e.point||!e.logical)return null;const i=t.coordinateToPrice(e.point.y);return null==i?null:{time:e.time||null,logical:e.logical,price:i.valueOf()}}static _getDiff(e,t){return{logical:e.logical-t.logical,price:e.price-t.price}}_addDiffToPoint(e,t,i){e&&(e.logical=e.logical+t,e.price=e.price+i,e.time=this.series.dataByIndex(e.logical)?.time||null)}_handleMouseDownInteraction=()=>{x._mouseIsDown=!0,this._onMouseDown()};_handleMouseUpInteraction=()=>{x._mouseIsDown=!1,this._moveToState(C.HOVERING)};_handleDragInteraction(e){if(this._state!=C.DRAGGING&&this._state!=C.DRAGGINGP1&&this._state!=C.DRAGGINGP2&&this._state!=C.DRAGGINGP3&&this._state!=C.DRAGGINGP4)return;const t=x._eventToPoint(e,this.series);if(!t)return;this._startDragPoint=this._startDragPoint||t;const i=x._getDiff(t,this._startDragPoint);this._onDrag(i),this.requestUpdate(),this._startDragPoint=t}}class M{_options;constructor(e){this._options=e}}class S extends M{_p1;_p2;_hovered;constructor(e,t,i,o){super(i),this._p1=e,this._p2=t,this._hovered=o}_getScaledCoordinates(e){return null===this._p1.x||null===this._p1.y||null===this._p2.x||null===this._p2.y?null:{x1:Math.round(this._p1.x*e.horizontalPixelRatio),y1:Math.round(this._p1.y*e.verticalPixelRatio),x2:Math.round(this._p2.x*e.horizontalPixelRatio),y2:Math.round(this._p2.y*e.verticalPixelRatio)}}_drawEndCircle(e,t,i){e.context.fillStyle="#000",e.context.beginPath(),e.context.arc(t,i,9,0,2*Math.PI),e.context.stroke(),e.context.fill()}}function L(e,i){const o={[t.LineStyle.Solid]:[],[t.LineStyle.Dotted]:[e.lineWidth,e.lineWidth],[t.LineStyle.Dashed]:[2*e.lineWidth,2*e.lineWidth],[t.LineStyle.LargeDashed]:[6*e.lineWidth,6*e.lineWidth],[t.LineStyle.SparseDotted]:[e.lineWidth,4*e.lineWidth]}[i];e.setLineDash(o)}class T extends M{_point={x:null,y:null};constructor(e,t){super(t),this._point=e}draw(e){e.useBitmapCoordinateSpace((e=>{if(null==this._point.y)return;const t=e.context,i=Math.round(this._point.y*e.verticalPixelRatio),o=this._point.x?this._point.x*e.horizontalPixelRatio:0;t.lineWidth=this._options.width,t.strokeStyle=this._options.lineColor,L(t,this._options.lineStyle),t.beginPath(),t.moveTo(o,i),t.lineTo(e.bitmapSize.width,i),t.stroke()}))}}class k{_source;constructor(e){this._source=e}}class E extends k{_p1={x:null,y:null};_p2={x:null,y:null};_source;constructor(e){super(e),this._source=e}update(){if(!this._source.p1||!this._source.p2)return;const e=this._source.series,t=e.priceToCoordinate(this._source.p1.price),i=e.priceToCoordinate(this._source.p2.price),o=this._getX(this._source.p1),s=this._getX(this._source.p2);this._p1={x:o,y:t},this._p2={x:s,y:i}}_getX(e){return this._source.chart.timeScale().logicalToCoordinate(e.logical)}}class D extends k{_source;_point={x:null,y:null};constructor(e){super(e),this._source=e}update(){const e=this._source._point,t=this._source.chart.timeScale(),i=this._source.series;"RayLine"==this._source._type&&(this._point.x=e.time?t.timeToCoordinate(e.time):t.logicalToCoordinate(e.logical)),this._point.y=i.priceToCoordinate(e.price)}renderer(){return new T(this._point,this._source._options)}}class I{_source;_y=null;_price=null;constructor(e){this._source=e}update(){if(!this._source.series||!this._source._point)return;this._y=this._source.series.priceToCoordinate(this._source._point.price);const e=this._source.series.options().priceFormat.precision;this._price=this._source._point.price.toFixed(e).toString()}visible(){return!0}tickVisible(){return!0}coordinate(){return this._y??0}text(){return this._source._options.text||this._price||""}textColor(){return"white"}backColor(){return this._source._options.lineColor}}class P extends x{_type="HorizontalLine";_paneViews;_point;_callbackName;_priceAxisViews;_startDragPoint=null;constructor(e,t,i=null){super(t),this._point=e,this._point.time=null,this._paneViews=[new D(this)],this._priceAxisViews=[new I(this)],this._callbackName=i}get points(){return[this._point]}updatePoints(...e){for(const t of e)t&&(this._point.price=t.price);this.requestUpdate()}updateAllViews(){this._paneViews.forEach((e=>e.update())),this._priceAxisViews.forEach((e=>e.update()))}priceAxisViews(){return this._priceAxisViews}_moveToState(e){switch(e){case C.NONE:document.body.style.cursor="default",this._unsubscribe("mousedown",this._handleMouseDownInteraction);break;case C.HOVERING:document.body.style.cursor="pointer",this._unsubscribe("mouseup",this._childHandleMouseUpInteraction),this._subscribe("mousedown",this._handleMouseDownInteraction),this.chart.applyOptions({handleScroll:!0});break;case C.DRAGGING:document.body.style.cursor="grabbing",this._subscribe("mouseup",this._childHandleMouseUpInteraction),this.chart.applyOptions({handleScroll:!1})}this._state=e}_onDrag(e){this._addDiffToPoint(this._point,0,e.price),this.requestUpdate()}_mouseIsOverDrawing(e,t=4){if(!e.point)return!1;const i=this.series.priceToCoordinate(this._point.price);return!!i&&Math.abs(i-e.point.y)<t}_onMouseDown(){this._startDragPoint=null;if(this._latestHoverPoint)return this._moveToState(C.DRAGGING)}_childHandleMouseUpInteraction=()=>{this._handleMouseUpInteraction(),this._callbackName&&window.callbackFunction(`${this._callbackName}_~_${this._point.price.toFixed(8)}`)}}class ${_chart;_series;_finishDrawingCallback=null;_drawings=[];_activeDrawing=null;_isDrawing=!1;_drawingType=null;constructor(e,t,i=null){this._chart=e,this._series=t,this._finishDrawingCallback=i,this._chart.subscribeClick(this._clickHandler),this._chart.subscribeCrosshairMove(this._moveHandler)}_clickHandler=e=>this._onClick(e);_moveHandler=e=>this._onMouseMove(e);beginDrawing(e){this._drawingType=e,this._isDrawing=!0}stopDrawing(){this._isDrawing=!1,this._activeDrawing=null}get drawings(){return this._drawings}addNewDrawing(e){this._series.attachPrimitive(e),this._drawings.push(e)}delete(e){if(null==e)return;const t=this._drawings.indexOf(e);-1!=t&&(this._drawings.splice(t,1),e.detach())}clearDrawings(){for(const e of this._drawings)e.detach();this._drawings=[]}repositionOnTime(){for(const e of this.drawings){const t=[];for(const i of e.points){if(!i){t.push(i);continue}const e=i.time?this._chart.timeScale().coordinateToLogical(this._chart.timeScale().timeToCoordinate(i.time)||0):i.logical;t.push({time:i.time,logical:e,price:i.price})}e.updatePoints(...t)}}_onClick(e){if(!this._isDrawing)return;const t=x._eventToPoint(e,this._series);if(t)if(null==this._activeDrawing){if(null==this._drawingType)return;this._activeDrawing=new this._drawingType(t,t),this._series.attachPrimitive(this._activeDrawing),this._drawingType==P&&this._onClick(e)}else{if(this._drawings.push(this._activeDrawing),this.stopDrawing(),!this._finishDrawingCallback)return;this._finishDrawingCallback()}}_onMouseMove(e){if(!e)return;for(const t of this._drawings)t._handleHoverInteraction(e);if(!this._isDrawing||!this._activeDrawing)return;const t=x._eventToPoint(e,this._series);t&&this._activeDrawing.updatePoints(null,t)}}class G extends S{constructor(e,t,i,o){super(e,t,i,o)}draw(e){e.useBitmapCoordinateSpace((e=>{if(null===this._p1.x||null===this._p1.y||null===this._p2.x||null===this._p2.y)return;const t=e.context,i=this._getScaledCoordinates(e);i&&(t.lineWidth=this._options.width,t.strokeStyle=this._options.lineColor,L(t,this._options.lineStyle),t.beginPath(),t.moveTo(i.x1,i.y1),t.lineTo(i.x2,i.y2),t.stroke(),this._hovered&&(this._drawEndCircle(e,i.x1,i.y1),this._drawEndCircle(e,i.x2,i.y2)))}))}}class O extends E{constructor(e){super(e)}renderer(){return new G(this._p1,this._p2,this._source._options,this._source.hovered)}}class A extends x{_paneViews=[];_hovered=!1;constructor(e,t,i){super(),this.points.push(e),this.points.push(t),this._options={...w,...i}}setFirstPoint(e){this.updatePoints(e)}setSecondPoint(e){this.updatePoints(null,e)}get p1(){return this.points[0]}get p2(){return this.points[1]}get hovered(){return this._hovered}}class B extends A{_type="TrendLine";constructor(e,t,i){super(e,t,i),this._paneViews=[new O(this)]}_moveToState(e){switch(e){case C.NONE:document.body.style.cursor="default",this._hovered=!1,this.requestUpdate(),this._unsubscribe("mousedown",this._handleMouseDownInteraction);break;case C.HOVERING:document.body.style.cursor="pointer",this._hovered=!0,this.requestUpdate(),this._subscribe("mousedown",this._handleMouseDownInteraction),this._unsubscribe("mouseup",this._handleMouseDownInteraction),this.chart.applyOptions({handleScroll:!0});break;case C.DRAGGINGP1:case C.DRAGGINGP2:case C.DRAGGING:document.body.style.cursor="grabbing",this._subscribe("mouseup",this._handleMouseUpInteraction),this.chart.applyOptions({handleScroll:!1})}this._state=e}_onDrag(e){this._state!=C.DRAGGING&&this._state!=C.DRAGGINGP1||this._addDiffToPoint(this.p1,e.logical,e.price),this._state!=C.DRAGGING&&this._state!=C.DRAGGINGP2||this._addDiffToPoint(this.p2,e.logical,e.price)}_onMouseDown(){this._startDragPoint=null;const e=this._latestHoverPoint;if(!e)return;const t=this._paneViews[0]._p1,i=this._paneViews[0]._p2;if(!(t.x&&i.x&&t.y&&i.y))return this._moveToState(C.DRAGGING);Math.abs(e.x-t.x)<10&&Math.abs(e.y-t.y)<10?this._moveToState(C.DRAGGINGP1):Math.abs(e.x-i.x)<10&&Math.abs(e.y-i.y)<10?this._moveToState(C.DRAGGINGP2):this._moveToState(C.DRAGGING)}_mouseIsOverDrawing(e,t=4){if(!e.point)return!1;const i=this._paneViews[0]._p1.x,o=this._paneViews[0]._p1.y,s=this._paneViews[0]._p2.x,n=this._paneViews[0]._p2.y;if(!(i&&s&&o&&n))return!1;const r=e.point.x,a=e.point.y;if(r<=Math.min(i,s)-t||r>=Math.max(i,s)+t)return!1;return Math.abs((n-o)*r-(s-i)*a+s*o-n*i)/Math.sqrt((n-o)**2+(s-i)**2)<=t}}class R extends S{constructor(e,t,i,o){super(e,t,i,o)}draw(e){e.useBitmapCoordinateSpace((e=>{const t=e.context,i=this._getScaledCoordinates(e);if(!i)return;t.lineWidth=this._options.width,t.strokeStyle=this._options.lineColor,L(t,this._options.lineStyle),t.fillStyle=this._options.fillColor;const o=Math.min(i.x1,i.x2),s=Math.min(i.y1,i.y2),n=Math.abs(i.x1-i.x2),r=Math.abs(i.y1-i.y2);t.strokeRect(o,s,n,r),t.fillRect(o,s,n,r),this._hovered&&(this._drawEndCircle(e,o,s),this._drawEndCircle(e,o+n,s),this._drawEndCircle(e,o+n,s+r),this._drawEndCircle(e,o,s+r))}))}}class F extends E{constructor(e){super(e)}renderer(){return new R(this._p1,this._p2,this._source._options,this._source.hovered)}}const N={fillEnabled:!0,fillColor:"rgba(255, 255, 255, 0.2)",...w};class V extends A{_type="Box";constructor(e,t,i){super(e,t,i),this._options={...N,...i},this._paneViews=[new F(this)]}_moveToState(e){switch(e){case C.NONE:document.body.style.cursor="default",this._hovered=!1,this._unsubscribe("mousedown",this._handleMouseDownInteraction);break;case C.HOVERING:document.body.style.cursor="pointer",this._hovered=!0,this._unsubscribe("mouseup",this._handleMouseUpInteraction),this._subscribe("mousedown",this._handleMouseDownInteraction),this.chart.applyOptions({handleScroll:!0});break;case C.DRAGGINGP1:case C.DRAGGINGP2:case C.DRAGGINGP3:case C.DRAGGINGP4:case C.DRAGGING:document.body.style.cursor="grabbing",document.body.addEventListener("mouseup",this._handleMouseUpInteraction),this._subscribe("mouseup",this._handleMouseUpInteraction),this.chart.applyOptions({handleScroll:!1})}this._state=e}_onDrag(e){this._state!=C.DRAGGING&&this._state!=C.DRAGGINGP1||this._addDiffToPoint(this.p1,e.logical,e.price),this._state!=C.DRAGGING&&this._state!=C.DRAGGINGP2||this._addDiffToPoint(this.p2,e.logical,e.price),this._state!=C.DRAGGING&&(this._state==C.DRAGGINGP3&&(this._addDiffToPoint(this.p1,e.logical,0),this._addDiffToPoint(this.p2,0,e.price)),this._state==C.DRAGGINGP4&&(this._addDiffToPoint(this.p1,0,e.price),this._addDiffToPoint(this.p2,e.logical,0)))}_onMouseDown(){this._startDragPoint=null;const e=this._latestHoverPoint,t=this._paneViews[0]._p1,i=this._paneViews[0]._p2;if(!(t.x&&i.x&&t.y&&i.y))return this._moveToState(C.DRAGGING);const o=10;Math.abs(e.x-t.x)<o&&Math.abs(e.y-t.y)<o?this._moveToState(C.DRAGGINGP1):Math.abs(e.x-i.x)<o&&Math.abs(e.y-i.y)<o?this._moveToState(C.DRAGGINGP2):Math.abs(e.x-t.x)<o&&Math.abs(e.y-i.y)<o?this._moveToState(C.DRAGGINGP3):Math.abs(e.x-i.x)<o&&Math.abs(e.y-t.y)<o?this._moveToState(C.DRAGGINGP4):this._moveToState(C.DRAGGING)}_mouseIsOverDrawing(e,t=4){if(!e.point)return!1;const i=this._paneViews[0]._p1.x,o=this._paneViews[0]._p1.y,s=this._paneViews[0]._p2.x,n=this._paneViews[0]._p2.y;if(!(i&&s&&o&&n))return!1;const r=e.point.x,a=e.point.y,l=Math.min(i,s),c=Math.min(o,n),d=Math.abs(i-s),h=Math.abs(o-n),p=t/2;return r>l-p&&r<l+d+p&&a>c-p&&a<c+h+p}}class H extends P{_type="RayLine";constructor(e,t){super({...e},t),this._point.time=e.time}updatePoints(...e){for(const t of e)t&&(this._point=t);this.requestUpdate()}_onDrag(e){this._addDiffToPoint(this._point,e.logical,e.price),this.requestUpdate()}_mouseIsOverDrawing(e,t=4){if(!e.point)return!1;const i=this.series.priceToCoordinate(this._point.price),o=this._point.time?this.chart.timeScale().timeToCoordinate(this._point.time):null;return!(!i||!o)&&(Math.abs(i-e.point.y)<t&&e.point.x>o-t)}}class U extends M{_point={x:null,y:null};constructor(e,t){super(t),this._point=e}draw(e){e.useBitmapCoordinateSpace((e=>{if(null==this._point.x)return;const t=e.context,i=this._point.x*e.horizontalPixelRatio;t.lineWidth=this._options.width,t.strokeStyle=this._options.lineColor,L(t,this._options.lineStyle),t.beginPath(),t.moveTo(i,0),t.lineTo(i,e.bitmapSize.height),t.stroke()}))}}class W extends k{_source;_point={x:null,y:null};constructor(e){super(e),this._source=e}update(){const e=this._source._point,t=this._source.chart.timeScale(),i=this._source.series;this._point.x=e.time?t.timeToCoordinate(e.time):t.logicalToCoordinate(e.logical),this._point.y=i.priceToCoordinate(e.price)}renderer(){return new U(this._point,this._source._options)}}class z{_source;_x=null;constructor(e){this._source=e}update(){if(!this._source.chart||!this._source._point)return;const e=this._source._point,t=this._source.chart.timeScale();this._x=e.time?t.timeToCoordinate(e.time):t.logicalToCoordinate(e.logical)}visible(){return!!this._source._options.text}tickVisible(){return!0}coordinate(){return this._x??0}text(){return this._source._options.text||""}textColor(){return"white"}backColor(){return this._source._options.lineColor}}class j extends x{_type="VerticalLine";_paneViews;_timeAxisViews;_point;_callbackName;_startDragPoint=null;constructor(e,t,i=null){super(t),this._point=e,this._paneViews=[new W(this)],this._callbackName=i,this._timeAxisViews=[new z(this)]}updateAllViews(){this._paneViews.forEach((e=>e.update())),this._timeAxisViews.forEach((e=>e.update()))}timeAxisViews(){return this._timeAxisViews}updatePoints(...e){for(const t of e)t&&(!t.time&&t.logical&&(t.time=this.series.dataByIndex(t.logical)?.time||null),this._point=t);this.requestUpdate()}get points(){return[this._point]}_moveToState(e){switch(e){case C.NONE:document.body.style.cursor="default",this._unsubscribe("mousedown",this._handleMouseDownInteraction);break;case C.HOVERING:document.body.style.cursor="pointer",this._unsubscribe("mouseup",this._childHandleMouseUpInteraction),this._subscribe("mousedown",this._handleMouseDownInteraction),this.chart.applyOptions({handleScroll:!0});break;case C.DRAGGING:document.body.style.cursor="grabbing",this._subscribe("mouseup",this._childHandleMouseUpInteraction),this.chart.applyOptions({handleScroll:!1})}this._state=e}_onDrag(e){this._addDiffToPoint(this._point,e.logical,0),this.requestUpdate()}_mouseIsOverDrawing(e,t=4){if(!e.point)return!1;const i=this.chart.timeScale();let o;return o=this._point.time?i.timeToCoordinate(this._point.time):i.logicalToCoordinate(this._point.logical),!!o&&Math.abs(o-e.point.x)<t}_onMouseDown(){this._startDragPoint=null;if(this._latestHoverPoint)return this._moveToState(C.DRAGGING)}_childHandleMouseUpInteraction=()=>{this._handleMouseUpInteraction(),this._callbackName&&window.callbackFunction(`${this._callbackName}_~_${this._point.price.toFixed(8)}`)}}class q{static TREND_SVG='<rect x="3.84" y="13.67" transform="matrix(0.7071 -0.7071 0.7071 0.7071 -5.9847 14.4482)" width="21.21" height="1.56"/><path d="M23,3.17L20.17,6L23,8.83L25.83,6L23,3.17z M23,7.41L21.59,6L23,4.59L24.41,6L23,7.41z"/><path d="M6,20.17L3.17,23L6,25.83L8.83,23L6,20.17z M6,24.41L4.59,23L6,21.59L7.41,23L6,24.41z"/>';static HORZ_SVG='<rect x="4" y="14" width="9" height="1"/><rect x="16" y="14" width="9" height="1"/><path d="M11.67,14.5l2.83,2.83l2.83-2.83l-2.83-2.83L11.67,14.5z M15.91,14.5l-1.41,1.41l-1.41-1.41l1.41-1.41L15.91,14.5z"/>';static RAY_SVG='<rect x="8" y="14" width="17" height="1"/><path d="M3.67,14.5l2.83,2.83l2.83-2.83L6.5,11.67L3.67,14.5z M7.91,14.5L6.5,15.91L5.09,14.5l1.41-1.41L7.91,14.5z"/>';static BOX_SVG='<rect x="8" y="6" width="12" height="1"/><rect x="9" y="22" width="11" height="1"/><path d="M3.67,6.5L6.5,9.33L9.33,6.5L6.5,3.67L3.67,6.5z M7.91,6.5L6.5,7.91L5.09,6.5L6.5,5.09L7.91,6.5z"/><path d="M19.67,6.5l2.83,2.83l2.83-2.83L22.5,3.67L19.67,6.5z M23.91,6.5L22.5,7.91L21.09,6.5l1.41-1.41L23.91,6.5z"/><path d="M19.67,22.5l2.83,2.83l2.83-2.83l-2.83-2.83L19.67,22.5z M23.91,22.5l-1.41,1.41l-1.41-1.41l1.41-1.41L23.91,22.5z"/><path d="M3.67,22.5l2.83,2.83l2.83-2.83L6.5,19.67L3.67,22.5z M7.91,22.5L6.5,23.91L5.09,22.5l1.41-1.41L7.91,22.5z"/><rect x="22" y="9" width="1" height="11"/><rect x="6" y="9" width="1" height="11"/>';static VERT_SVG=q.RAY_SVG;div;activeIcon=null;buttons=[];_commandFunctions;_handlerID;_drawingTool;handler;constructor(e,t,i,o,s){this._handlerID=t,this._commandFunctions=s,this._drawingTool=new $(i,o,(()=>this.removeActiveAndSave())),this.div=this._makeToolBox(),this.handler=e,this.handler.ContextMenu.setupDrawingTools(this.saveDrawings,this._drawingTool),s.push((e=>{if((e.metaKey||e.ctrlKey)&&"KeyZ"===e.code){const e=this._drawingTool.drawings.pop();return e&&this._drawingTool.delete(e),!0}return!1}))}toJSON(){const{...e}=this;return e}_makeToolBox(){let e=document.createElement("div");e.classList.add("toolbox"),this.buttons.push(this._makeToolBoxElement(B,"KeyT",q.TREND_SVG)),this.buttons.push(this._makeToolBoxElement(P,"KeyH",q.HORZ_SVG)),this.buttons.push(this._makeToolBoxElement(H,"KeyR",q.RAY_SVG)),this.buttons.push(this._makeToolBoxElement(V,"KeyB",q.BOX_SVG)),this.buttons.push(this._makeToolBoxElement(j,"KeyV",q.VERT_SVG,!0));for(const t of this.buttons)e.appendChild(t);return e}_makeToolBoxElement(e,t,i,o=!1){const s=document.createElement("div");s.classList.add("toolbox-button");const n=document.createElementNS("http://www.w3.org/2000/svg","svg");n.setAttribute("width","29"),n.setAttribute("height","29");const r=document.createElementNS("http://www.w3.org/2000/svg","g");r.innerHTML=i,r.setAttribute("fill",window.pane.color),n.appendChild(r),s.appendChild(n);const a={div:s,group:r,type:e};return s.addEventListener("click",(()=>this._onIconClick(a))),this._commandFunctions.push((e=>this._handlerID===window.handlerInFocus&&(!(!e.altKey||e.code!==t)&&(e.preventDefault(),this._onIconClick(a),!0)))),1==o&&(n.style.transform="rotate(90deg)",n.style.transformBox="fill-box",n.style.transformOrigin="center"),s}_onIconClick(e){this.activeIcon&&(this.activeIcon.div.classList.remove("active-toolbox-button"),window.setCursor("crosshair"),this._drawingTool?.stopDrawing(),this.activeIcon===e)?this.activeIcon=null:(this.activeIcon=e,this.activeIcon.div.classList.add("active-toolbox-button"),window.setCursor("crosshair"),this._drawingTool?.beginDrawing(this.activeIcon.type))}removeActiveAndSave=()=>{window.setCursor("default"),this.activeIcon&&this.activeIcon.div.classList.remove("active-toolbox-button"),this.activeIcon=null,this.saveDrawings()};addNewDrawing(e){this._drawingTool.addNewDrawing(e)}clearDrawings(){this._drawingTool.clearDrawings()}saveDrawings=()=>{const e=[];for(const t of this._drawingTool.drawings)e.push({type:t._type,points:t.points,options:t._options});const t=JSON.stringify(e);window.callbackFunction(`save_drawings${this._handlerID}_~_${t}`)};loadDrawings(e){e.forEach((e=>{switch(e.type){case"Box":this._drawingTool.addNewDrawing(new V(e.points[0],e.points[1],e.options));break;case"TrendLine":this._drawingTool.addNewDrawing(new B(e.points[0],e.points[1],e.options));break;case"HorizontalLine":this._drawingTool.addNewDrawing(new P(e.points[0],e.options));break;case"RayLine":this._drawingTool.addNewDrawing(new H(e.points[0],e.options));break;case"VerticalLine":this._drawingTool.addNewDrawing(new j(e.points[0],e.options))}}))}}class Y{makeButton;callbackName;div;isOpen=!1;widget;constructor(e,t,i,o,s,n){this.makeButton=e,this.callbackName=t,this.div=document.createElement("div"),this.div.classList.add("topbar-menu"),this.widget=this.makeButton(o+" ↓",null,s,!0,n),this.updateMenuItems(i),this.widget.elem.addEventListener("click",(()=>{if(this.isOpen=!this.isOpen,!this.isOpen)return void(this.div.style.display="none");let e=this.widget.elem.getBoundingClientRect();this.div.style.display="flex",this.div.style.flexDirection="column";let t=e.x+e.width/2;this.div.style.left=t-this.div.clientWidth/2+"px",this.div.style.top=e.y+e.height+"px"})),document.body.appendChild(this.div)}updateMenuItems(e){this.div.innerHTML="",e.forEach((e=>{let t=this.makeButton(e,null,!1,!1);t.elem.addEventListener("click",(()=>{this._clickHandler(t.elem.innerText)})),t.elem.style.margin="4px 4px",t.elem.style.padding="2px 2px",this.div.appendChild(t.elem)})),this.widget.elem.innerText=e[0]+" ↓"}_clickHandler(e){this.widget.elem.innerText=e+" ↓",window.callbackFunction(`${this.callbackName}_~_${e}`),this.div.style.display="none",this.isOpen=!1}}class X{_handler;_div;left;right;constructor(e){this._handler=e,this._div=document.createElement("div"),this._div.classList.add("topbar");const t=e=>{const t=document.createElement("div");return t.classList.add("topbar-container"),t.style.justifyContent=e,this._div.appendChild(t),t};this.left=t("flex-start"),this.right=t("flex-end")}makeSwitcher(e,t,i,o="left"){const s=document.createElement("div");let n;s.style.margin="4px 12px";const r={elem:s,callbackName:i,intervalElements:e.map((e=>{const i=document.createElement("button");i.classList.add("topbar-button"),i.classList.add("switcher-button"),i.style.margin="0px 2px",i.innerText=e,e==t&&(n=i,i.classList.add("active-switcher-button"));const o=X.getClientWidth(i);return i.style.minWidth=o+1+"px",i.addEventListener("click",(()=>r.onItemClicked(i))),s.appendChild(i),i})),onItemClicked:e=>{e!=n&&(n.classList.remove("active-switcher-button"),e.classList.add("active-switcher-button"),n=e,window.callbackFunction(`${r.callbackName}_~_${e.innerText}`))}};return this.appendWidget(s,o,!0),r}makeTextBoxWidget(e,t="left",i=null){if(i){const o=document.createElement("input");return o.classList.add("topbar-textbox-input"),o.value=e,o.style.width=`${o.value.length+2}ch`,o.addEventListener("focus",(()=>{window.textBoxFocused=!0})),o.addEventListener("input",(e=>{e.preventDefault(),o.style.width=`${o.value.length+2}ch`})),o.addEventListener("keydown",(e=>{"Enter"==e.key&&(e.preventDefault(),o.blur())})),o.addEventListener("blur",(()=>{window.callbackFunction(`${i}_~_${o.value}`),window.textBoxFocused=!1})),this.appendWidget(o,t,!0),o}{const i=document.createElement("div");return i.classList.add("topbar-textbox"),i.innerText=e,this.appendWidget(i,t,!0),i}}makeMenu(e,t,i,o,s){return new Y(this.makeButton.bind(this),o,e,t,i,s)}makeButton(e,t,i,o=!0,s="left",n=!1){let r=document.createElement("button");r.classList.add("topbar-button"),r.innerText=e,document.body.appendChild(r),r.style.minWidth=r.clientWidth+1+"px",document.body.removeChild(r);let a={elem:r,callbackName:t};if(t){let e;if(n){let t=!1;e=()=>{t=!t,window.callbackFunction(`${a.callbackName}_~_${t}`),r.style.backgroundColor=t?"var(--active-bg-color)":"",r.style.color=t?"var(--active-color)":""}}else e=()=>window.callbackFunction(`${a.callbackName}_~_${r.innerText}`);r.addEventListener("click",e)}return o&&this.appendWidget(r,s,i),a}makeSeparator(e="left"){const t=document.createElement("div");t.classList.add("topbar-seperator");("left"==e?this.left:this.right).appendChild(t)}appendWidget(e,t,i){const o="left"==t?this.left:this.right;i?("left"==t&&o.appendChild(e),this.makeSeparator(t),"right"==t&&o.appendChild(e)):o.appendChild(e),this._handler.reSize()}static getClientWidth(e){document.body.appendChild(e);const t=e.clientWidth;return document.body.removeChild(e),t}}const K={title:"",followMode:"tracking",horizontalDeadzoneWidth:45,verticalDeadzoneHeight:100,verticalSpacing:20,topOffset:20};class Z{_chart;_element;_titleElement;_priceElement;_dateElement;_timeElement;_options;_lastTooltipWidth=null;constructor(e,t){this._options={...K,...t},this._chart=e;const i=document.createElement("div");Q(i,{display:"flex","flex-direction":"column","align-items":"center",position:"absolute",transform:"translate(calc(0px - 50%), 0px)",opacity:"0",left:"0%",top:"0","z-index":"100","background-color":"white","border-radius":"4px",padding:"5px 10px","font-family":"-apple-system, BlinkMacSystemFont, 'Trebuchet MS', Roboto, Ubuntu, sans-serif","font-size":"12px","font-weight":"400","box-shadow":"0px 2px 4px rgba(0, 0, 0, 0.2)","line-height":"16px","pointer-events":"none",color:"#131722"});const o=document.createElement("div");Q(o,{"font-size":"12px","line-height":"24px","font-weight":"590"}),J(o,this._options.title),i.appendChild(o);const s=document.createElement("div");Q(s,{"font-size":"12px","line-height":"18px","font-weight":"590"}),J(s,""),i.appendChild(s);const n=document.createElement("div");Q(n,{color:"#787B86"}),J(n,""),i.appendChild(n);const r=document.createElement("div");Q(r,{color:"#787B86"}),J(r,""),i.appendChild(r),this._element=i,this._titleElement=o,this._priceElement=s,this._dateElement=n,this._timeElement=r;const a=this._chart.chartElement();a.appendChild(this._element);const l=a.parentElement;if(!l)return void console.error("Chart Element is not attached to the page.");const c=getComputedStyle(l).position;"relative"!==c&&"absolute"!==c&&console.error("Chart Element position is expected be `relative` or `absolute`.")}destroy(){this._chart&&this._element&&this._chart.chartElement().removeChild(this._element)}applyOptions(e){this._options={...this._options,...e}}options(){return this._options}updateTooltipContent(e){if(!this._element)return void console.warn("Tooltip element not found.");const t=this._element.getBoundingClientRect();this._lastTooltipWidth=t.width,void 0!==e.title&&this._titleElement?(console.log(`Setting title: ${e.title}`),J(this._titleElement,e.title)):console.warn("Title element is missing or title data is undefined."),J(this._priceElement,e.price),J(this._dateElement,e.date),J(this._timeElement,e.time)}updatePosition(e){if(!this._chart||!this._element)return;if(this._element.style.opacity=e.visible?"1":"0",!e.visible)return;const t=this._calculateXPosition(e,this._chart),i=this._calculateYPosition(e);this._element.style.transform=`translate(${t}, ${i})`}_calculateXPosition(e,t){const i=e.paneX+t.priceScale("left").width(),o=this._lastTooltipWidth?Math.ceil(this._lastTooltipWidth/2):this._options.horizontalDeadzoneWidth;return`calc(${Math.min(Math.max(o,i),t.timeScale().width()-o)}px - 50%)`}_calculateYPosition(e){if("top"==this._options.followMode)return`${this._options.topOffset}px`;const t=e.paneY,i=t<=this._options.verticalSpacing+this._options.verticalDeadzoneHeight;return`calc(${t+(i?1:-1)*this._options.verticalSpacing}px${i?"":" - 100%"})`}}function J(e,t){e&&t!==e.innerText&&(e.innerText=t,e.style.display=t?"block":"none")}function Q(e,t){for(const[i,o]of Object.entries(t))e.style.setProperty(i,o)}function ee(e,t,i=1,o){const s=Math.round(t*e),n=Math.round(i*t),r=function(e){return Math.floor(.5*e)}(n);return{position:s-r,length:n}}class te{_data;constructor(e){this._data=e}draw(e){this._data.visible&&e.useBitmapCoordinateSpace((e=>{const t=e.context,i=ee(this._data.x,e.horizontalPixelRatio,1);t.fillStyle=this._data.color,t.fillRect(i.position,this._data.topMargin*e.verticalPixelRatio,i.length,e.bitmapSize.height)}))}}class ie{_data;constructor(e){this._data=e}update(e){this._data=e}renderer(){return new te(this._data)}zOrder(){return"bottom"}}const oe={lineColor:"rgba(0, 0, 0, 0.2)",priceExtractor:e=>void 0!==e.value?e.value.toFixed(2):void 0!==e.close?e.close.toFixed(2):""};class se{_options;_tooltip=void 0;_paneViews;_data={x:0,visible:!1,color:"rgba(0, 0, 0, 0.2)",topMargin:0};_attachedParams;constructor(e){this._options={...oe,...e},this._data.color=this._options.lineColor,this._paneViews=[new ie(this._data)]}attached(e){this._attachedParams=e;const t=this.series();if(t){const e=t.options(),i=e.lineColor||e.color||"rgba(0,0,0,0.2)";this._options.autoColor&&this.applyOptions({lineColor:i})}this._setCrosshairMode(),e.chart.subscribeCrosshairMove(this._moveHandler),this._createTooltipElement()}detached(){const e=this.chart();e&&e.unsubscribeCrosshairMove(this._moveHandler),this._hideCrosshair(),this._hideTooltip()}paneViews(){return this._paneViews}updateAllViews(){this._paneViews.forEach((e=>e.update(this._data)))}setData(e){this._data=e,this.updateAllViews(),this._attachedParams?.requestUpdate()}currentColor(){return this._options.lineColor}chart(){return this._attachedParams?.chart}series(){return this._attachedParams?.series}applyOptions(e){this._options={...this._options,...e},e.lineColor&&this.setData({...this._data,color:e.lineColor}),this._tooltip&&this._tooltip.applyOptions({...this._options.tooltip}),this._attachedParams?.requestUpdate()}_setCrosshairMode(){const e=this.chart();if(!e)throw new Error("Unable to change crosshair mode because the chart instance is undefined");e.applyOptions({crosshair:{mode:t.CrosshairMode.Magnet,vertLine:{visible:!1,labelVisible:!1},horzLine:{visible:!1,labelVisible:!1}}})}_moveHandler=e=>this._onMouseMove(e);switch(e){if(this.series()===e)return void console.log("Tooltip is already attached to this series.");this._hideCrosshair(),e.attachPrimitive(this,"Tooltip",!0,!1);const t=e.options(),i=t.lineColor||t.color||"rgba(0,0,0,0.2)";this._options.autoColor&&this.applyOptions({lineColor:i}),console.log("Switched tooltip to the new series.")}_hideCrosshair(){this._hideTooltip(),this.setData({x:0,visible:!1,color:this._options.lineColor,topMargin:0})}_hideTooltip(){this._tooltip&&(this._tooltip.updateTooltipContent({title:"",price:"",date:"",time:""}),this._tooltip.updatePosition({paneX:0,paneY:0,visible:!1}))}_onMouseMove(e){const i=this.chart(),o=this.series(),s=e.logical;if(!s||!i||!o)return void this._hideCrosshair();const n=e.seriesData.get(o);if(!n)return void this._hideCrosshair();const r=this._options.priceExtractor(n),a=i.timeScale().logicalToCoordinate(s),[l,c]=function(e){if(!e)return["",""];const t=new Date(e),i=t.getFullYear(),o=t.toLocaleString("default",{month:"short"});return[`${t.getDate().toString().padStart(2,"0")} ${o} ${i}`,`${t.getHours().toString().padStart(2,"0")}:${t.getMinutes().toString().padStart(2,"0")}`]}(e.time?function(e){if(t.isUTCTimestamp(e))return 1e3*e;if(t.isBusinessDay(e))return new Date(e.year,e.month,e.day).valueOf();const[i,o,s]=e.split("-").map(parseInt);return new Date(i,o,s).valueOf()}(e.time):void 0);if(this._tooltip){const t=o.options()?.title||"Unknown Series",i=this._tooltip.options(),s="top"===i.followMode?i.topOffset+10:0;this.setData({x:a??0,visible:null!==a,color:this._options.lineColor,topMargin:s}),this._tooltip.updateTooltipContent({title:t,price:r,date:l,time:c}),this._tooltip.updatePosition({paneX:e.point?.x??0,paneY:e.point?.y??0,visible:!0})}}_createTooltipElement(){const e=this.chart();if(!e)throw new Error("Unable to create Tooltip element. Chart not attached");this._tooltip=new Z(e,{...this._options.tooltip})}}let ne=class e{container;_opacitySlider;_opacity_label;exitButton;color="#ff0000";rgba;opacity;applySelection;constructor(t,i){this.applySelection=i,this.rgba=e.extractRGBA(t),this.opacity=this.rgba[3],this.container=document.createElement("div"),this.container.classList.add("color-picker"),this.container.style.display="flex",this.container.style.flexDirection="column",this.container.style.width="150px",this.container.style.height="300px",this.container.style.position="relative";const o=this.createColorGrid(),s=this.createOpacityUI();this.exitButton=this.createExitButton(),this.container.appendChild(o),this.container.appendChild(this.createSeparator()),this.container.appendChild(this.createSeparator()),this.container.appendChild(s),this.container.appendChild(this.exitButton)}createExitButton(){const e=document.createElement("div");return e.innerText="✕",e.title="Close",e.style.position="absolute",e.style.bottom="5px",e.style.right="5px",e.style.width="20px",e.style.height="20px",e.style.cursor="pointer",e.style.display="flex",e.style.justifyContent="center",e.style.alignItems="center",e.style.fontSize="16px",e.style.backgroundColor="#ccc",e.style.borderRadius="50%",e.style.color="#000",e.style.boxShadow="0 1px 3px rgba(0,0,0,0.3)",e.addEventListener("mouseover",(()=>{e.style.backgroundColor="#e74c3c",e.style.color="#fff"})),e.addEventListener("mouseout",(()=>{e.style.backgroundColor="#ccc",e.style.color="#000"})),e.addEventListener("click",(()=>{this.closeMenu()})),e}createColorGrid(){const t=document.createElement("div");t.style.display="grid",t.style.gridTemplateColumns="repeat(7, 1fr)",t.style.gap="5px",t.style.overflowY="auto",t.style.flex="1";return e.generateFullSpectrumColors(9).forEach((e=>{const i=this.createColorBox(e);t.appendChild(i)})),t}createColorBox(t){const i=document.createElement("div");return i.style.aspectRatio="1",i.style.borderRadius="6px",i.style.backgroundColor=t,i.style.cursor="pointer",i.addEventListener("click",(()=>{this.rgba=e.extractRGBA(t),this.updateTargetColor()})),i}static generateFullSpectrumColors(e){const t=[];for(let i=0;i<=255;i+=Math.floor(255/e))t.push(`rgba(255, ${i}, 0, 1)`);for(let i=255;i>=0;i-=Math.floor(255/e))t.push(`rgba(${i}, 255, 0, 1)`);for(let i=0;i<=255;i+=Math.floor(255/e))t.push(`rgba(0, 255, ${i}, 1)`);for(let i=255;i>=0;i-=Math.floor(255/e))t.push(`rgba(0, ${i}, 255, 1)`);for(let i=0;i<=255;i+=Math.floor(255/e))t.push(`rgba(${i}, 0, 255, 1)`);for(let i=255;i>=0;i-=Math.floor(255/e))t.push(`rgba(255, 0, ${i}, 1)`);for(let i=255;i>=0;i-=Math.floor(255/e))t.push(`rgba(${i}, ${i}, ${i}, 1)`);return t}createOpacityUI(){const e=document.createElement("div");e.style.margin="10px",e.style.display="flex",e.style.flexDirection="column",e.style.alignItems="center";const t=document.createElement("div");return t.style.color="lightgray",t.style.fontSize="12px",t.innerText="Opacity",this._opacitySlider=document.createElement("input"),this._opacitySlider.type="range",this._opacitySlider.min="0",this._opacitySlider.max="100",this._opacitySlider.value=(100*this.opacity).toString(),this._opacitySlider.style.width="80%",this._opacity_label=document.createElement("div"),this._opacity_label.style.color="lightgray",this._opacity_label.style.fontSize="12px",this._opacity_label.innerText=`${this._opacitySlider.value}%`,this._opacitySlider.oninput=()=>{this._opacity_label.innerText=`${this._opacitySlider.value}%`,this.opacity=parseInt(this._opacitySlider.value)/100,this.updateTargetColor()},e.appendChild(t),e.appendChild(this._opacitySlider),e.appendChild(this._opacity_label),e}createSeparator(){const e=document.createElement("div");return e.style.height="1px",e.style.width="100%",e.style.backgroundColor="#ccc",e.style.margin="5px 0",e}openMenu(e,t,i){this.applySelection=i,this.container.style.display="block",document.body.appendChild(this.container),console.log("Menu attached:",this.container);const o=this.container.offsetWidth||150,s=this.container.offsetHeight||250;console.log("Submenu dimensions:",{submenuWidth:o,submenuHeight:s});const n=e.clientX,r=e.clientY;console.log("Mouse position:",{cursorX:n,cursorY:r});const a=window.innerWidth,l=window.innerHeight;let c=n+t,d=r;const h=c+o>a?n-o:c,p=d+s>l?l-s-10:d;console.log({left:c,top:d,adjustedLeft:h,adjustedTop:p}),this.container.style.left=`${h}px`,this.container.style.top=`${p}px`,this.container.style.display="flex",this.container.style.position="absolute",this.exitButton.style.bottom="5px",this.exitButton.style.right="5px",document.addEventListener("mousedown",this._handleOutsideClick.bind(this),{once:!0})}closeMenu(){this.container.style.display="none",document.removeEventListener("mousedown",this._handleOutsideClick)}_handleOutsideClick(e){this.container.contains(e.target)||this.closeMenu()}static extractRGBA(e){const t=document.createElement("div");t.style.color=e,document.body.appendChild(t);const i=getComputedStyle(t).color;document.body.removeChild(t);const o=i.match(/\d+/g)?.map(Number)||[0,0,0],s=i.includes("rgba")?parseFloat(i.split(",")[3]):1;return[o[0],o[1],o[2],s]}getElement(){return this.container}update(t,i){this.rgba=e.extractRGBA(t),this.opacity=this.rgba[3],this.applySelection=i,this.updateTargetColor()}updateTargetColor(){this.color=`rgba(${this.rgba[0]}, ${this.rgba[1]}, ${this.rgba[2]}, ${this.opacity})`,this.applySelection(this.color)}};class re{colorOption;static colors=["#EBB0B0","#E9CEA1","#E5DF80","#ADEB97","#A3C3EA","#D8BDED","#E15F5D","#E1B45F","#E2D947","#4BE940","#639AE1","#D7A0E8","#E42C2A","#E49D30","#E7D827","#3CFF0A","#3275E4","#B06CE3","#F3000D","#EE9A14","#F1DA13","#2DFC0F","#1562EE","#BB00EF","#B50911","#E3860E","#D2BD11","#48DE0E","#1455B4","#6E009F","#7C1713","#B76B12","#8D7A13","#479C12","#165579","#51007E"];_div;saveDrawings;opacity=0;_opacitySlider;_opacityLabel;rgba;constructor(e,t){this.colorOption=t,this.saveDrawings=e,this._div=document.createElement("div"),this._div.classList.add("color-picker");let i=document.createElement("div");i.style.margin="10px",i.style.display="flex",i.style.flexWrap="wrap",re.colors.forEach((e=>i.appendChild(this.makeColorBox(e))));let o=document.createElement("div");o.style.backgroundColor=window.pane.borderColor,o.style.height="1px",o.style.width="130px";let s=document.createElement("div");s.style.margin="10px";let n=document.createElement("div");n.style.color="lightgray",n.style.fontSize="12px",n.innerText="Opacity",this._opacityLabel=document.createElement("div"),this._opacityLabel.style.color="lightgray",this._opacityLabel.style.fontSize="12px",this._opacitySlider=document.createElement("input"),this._opacitySlider.type="range",this._opacitySlider.value=(100*this.opacity).toString(),this._opacityLabel.innerText=this._opacitySlider.value+"%",this._opacitySlider.oninput=()=>{this._opacityLabel.innerText=this._opacitySlider.value+"%",this.opacity=parseInt(this._opacitySlider.value)/100,this.updateColor()},s.appendChild(n),s.appendChild(this._opacitySlider),s.appendChild(this._opacityLabel),this._div.appendChild(i),this._div.appendChild(o),this._div.appendChild(s),window.containerDiv.appendChild(this._div)}_updateOpacitySlider(){this._opacitySlider.value=(100*this.opacity).toString(),this._opacityLabel.innerText=this._opacitySlider.value+"%"}makeColorBox(e){const t=document.createElement("div");t.style.width="18px",t.style.height="18px",t.style.borderRadius="3px",t.style.margin="3px",t.style.boxSizing="border-box",t.style.backgroundColor=e,t.addEventListener("mouseover",(()=>t.style.border="2px solid lightgray")),t.addEventListener("mouseout",(()=>t.style.border="none"));const i=re.extractRGBA(e);return t.addEventListener("click",(()=>{this.rgba=i,this.updateColor()})),t}static extractRGBA(e){const t=document.createElement("div");t.style.color=e,document.body.appendChild(t);const i=getComputedStyle(t).color;document.body.removeChild(t);const o=i.match(/\d+/g)?.map(Number);if(!o)return[];let s=i.includes("rgba")?parseFloat(i.split(",")[3]):1;return[o[0],o[1],o[2],s]}updateColor(){if(!x.lastHoveredObject||!this.rgba)return;const e=`rgba(${this.rgba[0]}, ${this.rgba[1]}, ${this.rgba[2]}, ${this.opacity})`;x.lastHoveredObject.applyOptions({[this.colorOption]:e}),this.saveDrawings()}openMenu(e){x.lastHoveredObject&&(this.rgba=re.extractRGBA(x.lastHoveredObject._options[this.colorOption]),this.opacity=this.rgba[3],this._updateOpacitySlider(),this._div.style.top=e.top-30+"px",this._div.style.left=e.right+"px",this._div.style.display="flex",setTimeout((()=>document.addEventListener("mousedown",(e=>{this._div.contains(e.target)||this.closeMenu()}))),10))}closeMenu(){document.body.removeEventListener("click",this.closeMenu),this._div.style.display="none"}}class ae{static _styles=[{name:"Solid",var:t.LineStyle.Solid},{name:"Dotted",var:t.LineStyle.Dotted},{name:"Dashed",var:t.LineStyle.Dashed},{name:"Large Dashed",var:t.LineStyle.LargeDashed},{name:"Sparse Dotted",var:t.LineStyle.SparseDotted}];_div;_saveDrawings;constructor(e){this._saveDrawings=e,this._div=document.createElement("div"),this._div.classList.add("context-menu"),ae._styles.forEach((e=>{this._div.appendChild(this._makeTextBox(e.name,e.var))})),window.containerDiv.appendChild(this._div)}_makeTextBox(e,t){const i=document.createElement("span");return i.classList.add("context-menu-item"),i.innerText=e,i.addEventListener("click",(()=>{x.lastHoveredObject?.applyOptions({lineStyle:t}),this._saveDrawings()})),i}openMenu(e){this._div.style.top=e.top-30+"px",this._div.style.left=e.right+"px",this._div.style.display="block",setTimeout((()=>document.addEventListener("mousedown",(e=>{this._div.contains(e.target)||this.closeMenu()}))),10)}closeMenu(){document.removeEventListener("click",this.closeMenu),this._div.style.display="none"}}function le(e,t){const i=e.split("."),o={};let s=o;for(let e=0;e<i.length;e++){const o=i[e];e===i.length-1?s[o]=t:(s[o]={},s=s[o])}return o}var ce;!function(e){e.Line="Line",e.Histogram="Histogram",e.Area="Area",e.Bar="Bar",e.Candlestick="Candlestick"}(ce||(ce={}));let de=null;function he(e){return e.replace(/([A-Z])/g," $1").replace(/^./,(e=>e.toUpperCase()))}class pe{handler;handlerMap;getMouseEventParams;div;hoverItem;items=[];colorPicker=new ne("#ff0000",(()=>null));saveDrawings=null;drawingTool=null;mouseEventParams=null;constraints={baseline:{skip:!0},title:{skip:!0},PriceLineSource:{skip:!0},tickInterval:{min:0,max:100},lastPriceAnimation:{skip:!0},lineType:{min:0,max:2}};setupDrawingTools(e,t){this.saveDrawings=e,this.drawingTool=t}shouldSkipOption(e){return!!(this.constraints[e]||{}).skip}separator(){const e=document.createElement("div");e.style.width="90%",e.style.height="1px",e.style.margin="3px 0px",e.style.backgroundColor=window.pane.borderColor,this.div.appendChild(e),this.items.push(e)}menuItem(e,t,i=null){const o=document.createElement("span");o.classList.add("context-menu-item"),this.div.appendChild(o);const s=document.createElement("span");if(s.innerText=e,s.style.pointerEvents="none",o.appendChild(s),i){let e=document.createElement("span");e.innerText="►",e.style.fontSize="8px",e.style.pointerEvents="none",o.appendChild(e)}if(o.addEventListener("mouseover",(()=>{this.hoverItem&&this.hoverItem.closeAction&&this.hoverItem.closeAction(),this.hoverItem={elem:s,action:t,closeAction:i}})),i){let e;o.addEventListener("mouseover",(()=>e=setTimeout((()=>t(o.getBoundingClientRect())),100))),o.addEventListener("mouseout",(()=>clearTimeout(e)))}else o.addEventListener("click",(e=>{t(e),this.div.style.display="none"}));this.items.push(o)}constructor(e,t,i){this.handler=e,this.handlerMap=t,this.getMouseEventParams=i,this.div=document.createElement("div"),this.div.classList.add("context-menu"),document.body.appendChild(this.div),this.div.style.overflowY="scroll",this.hoverItem=null,this.mouseEventParams=i(),document.body.addEventListener("contextmenu",this._onRightClick.bind(this)),document.body.addEventListener("click",this._onClick.bind(this)),this.setupMenu()}_onClick(e){const t=e.target;[this.colorPicker].forEach((e=>{e.getElement().contains(t)||e.closeMenu()}))}_onRightClick(e){e.preventDefault();const t=this.getMouseEventParams(),i=this.getProximitySeries(this.getMouseEventParams()),o=this.getProximityDrawing();console.log("Mouse Event Params:",t),console.log("Proximity Series:",i),console.log("Proximity Drawing:",o),this.clearMenu(),this.clearAllMenus(),i?(console.log("Right-click detected on a series (proximity)."),this.populateSeriesMenu(i,e)):o?(console.log("Right-click detected on a drawing."),this.populateDrawingMenu(o,e)):t?.hoveredSeries?(console.log("Right-click detected on a series (hovered)."),this.populateSeriesMenu(t.hoveredSeries,e)):(console.log("Right-click detected on the chart background."),this.populateChartMenu(e)),this.showMenu(e),e.preventDefault(),e.stopPropagation()}getProximityDrawing(){return x.hoveredObject?x.hoveredObject:null}getProximitySeries(e){if(!e||!e.seriesData)return console.warn("No mouse event parameters or series data available."),null;if(!e.point)return console.warn("No point data in MouseEventParams."),null;const t=e.point.y;let i=null;const o=this.handler._seriesList[0];if(this.handler.series)i=this.handler.series,console.log("Using handler.series for coordinate conversion.");else{if(!o)return console.warn("No handler.series or referenceSeries available."),null;i=o,console.log("Using referenceSeries for coordinate conversion.")}const s=i.coordinateToPrice(t);if(console.log(`Converted chart Y (${t}) to Price: ${s}`),null===s)return console.warn("Cursor price is null. Unable to determine proximity."),null;const n=[];return e.seriesData.forEach(((e,t)=>{let i;if(!function(e){return"value"in e}(e)?function(e){return"close"in e&&"open"in e&&"high"in e&&"low"in e}(e)&&(i=e.close):i=e.value,void 0!==i&&!isNaN(i)){const e=Math.abs(i-s);e/s*100<=3.33&&n.push({distance:e,series:t})}})),n.sort(((e,t)=>e.distance-t.distance)),n.length>0?(console.log("Closest series found."),n[0].series):(console.log("No series found within the proximity threshold."),null)}showMenu(e){const t=e.clientX,i=e.clientY;this.div.style.position="absolute",this.div.style.zIndex="1000",this.div.style.left=`${t}px`,this.div.style.top=`${i}px`,this.div.style.width="225px",this.div.style.maxHeight="400px",this.div.style.overflowY="scroll",this.div.style.display="block",console.log("Displaying Menu at:",t,i),de=this.div,console.log("Displaying Menu",t,i),document.addEventListener("mousedown",this.hideMenuOnOutsideClick.bind(this),{once:!0})}hideMenuOnOutsideClick(e){this.div.contains(e.target)||this.hideMenu()}hideMenu(){this.div.style.display="none",de===this.div&&(de=null)}resetView(){this.handler.chart.timeScale().resetTimeScale(),this.handler.chart.timeScale().fitContent()}clearAllMenus(){this.handlerMap.forEach((e=>{e.ContextMenu&&e.ContextMenu.clearMenu()}))}setupMenu(){if(!this.div.querySelector(".chart-options-container")){const e=document.createElement("div");e.classList.add("chart-options-container"),this.div.appendChild(e)}this.div.querySelector(".context-menu-item.close-menu")||this.addMenuItem("Close Menu",(()=>this.hideMenu()))}addNumberInput(e,t,i,o,s){return this.addMenuInput(this.div,{type:"number",label:e,value:t,onChange:i,min:o,max:s},"")}addCheckbox(e,t,i){return this.addMenuInput(this.div,{type:"boolean",label:e,value:t,onChange:i})}addMenuInput(e,t,i=""){let o;if("number"===t.type||"string"===t.type||"boolean"===t.type){if(o=document.createElement("div"),o.classList.add("context-menu-item"),o.style.display="flex",o.style.alignItems="center",o.style.justifyContent="space-between",t.label){const e=document.createElement("label");e.innerText=t.label,e.htmlFor=`${i}${t.label.toLowerCase()}`,e.style.marginRight="8px",o.appendChild(e)}let e;"number"===t.type?(e=document.createElement("input"),e.type="number",e.value=void 0!==t.value?t.value.toString():"",e.style.width="45px",e.style.marginLeft="auto",e.style.cursor="pointer",void 0!==t.min&&(e.min=t.min.toString()),void 0!==t.max&&(e.max=t.max.toString()),e.addEventListener("input",(i=>{const o=i.target;let s=parseFloat(o.value);const n=t.label,r=this.constraints[n.toLowerCase()];r&&!r.skip&&(void 0!==r.min&&s<r.min&&(s=r.min,e.value=s.toString()),void 0!==r.max&&s>r.max&&(s=r.max,e.value=s.toString())),isNaN(s)||t.onChange(s)})),o.appendChild(e)):"boolean"===t.type?(e=document.createElement("input"),e.type="checkbox",e.checked=t.value??!1,e.style.marginLeft="auto",e.style.cursor="pointer",e.addEventListener("change",(e=>{const i=e.target;t.onChange(i.checked)})),o.appendChild(e)):(e=document.createElement("input"),e.type="text",e.value=t.value??"",e.style.marginLeft="auto",e.style.cursor="pointer",e.addEventListener("input",(e=>{const i=e.target;t.onChange(i.value)})),o.appendChild(e))}else if("select"===t.type){if(o=document.createElement("div"),o.classList.add("context-menu-item"),o.style.display="flex",o.style.alignItems="center",o.style.justifyContent="space-between",t.label){const e=document.createElement("label");e.innerText=t.label,e.htmlFor=`${i}${t.label.toLowerCase()}`,e.style.marginRight="8px",o.appendChild(e)}const e=document.createElement("select");e.id=`${i}${t.label?t.label.toLowerCase():"select"}`,e.style.marginLeft="auto",e.style.cursor="pointer",t.options?.forEach((i=>{const o=document.createElement("option");o.value=i,o.text=i,i===t.value&&(o.selected=!0),e.appendChild(o)})),e.addEventListener("change",(e=>{const i=e.target;t.onChange&&t.onChange(i.value)})),o.appendChild(e)}else o=document.createElement("span"),o.classList.add("context-menu-item"),o.innerText=t.label||"Action",o.style.cursor="pointer",o.addEventListener("click",(e=>{e.stopPropagation(),t.action&&t.action()}));return e.appendChild(o),o}addMenuItem(e,t,i=!0,o=!1,s=1){const n=document.createElement("span");if(n.classList.add("context-menu-item"),n.innerText=e,o){const e=document.createElement("span");e.classList.add("submenu-arrow"),e.innerText="ː".repeat(s),n.appendChild(e)}n.addEventListener("click",(e=>{e.stopPropagation(),t(),i&&this.hideMenu()}));const r=["➩","➯","➱","➬","➫"];return n.addEventListener("mouseenter",(()=>{if(n.style.backgroundColor="royalblue",n.style.color="white",!n.querySelector(".hover-arrow")){const e=document.createElement("span");e.classList.add("hover-arrow");const t=Math.floor(Math.random()*r.length),i=r[t];e.innerText=i,e.style.marginLeft="auto",e.style.fontSize="14px",e.style.color="white",n.appendChild(e)}})),n.addEventListener("mouseleave",(()=>{n.style.backgroundColor="",n.style.color="";const e=n.querySelector(".hover-arrow");e&&n.removeChild(e)})),this.div.appendChild(n),this.items.push(n),n}clearMenu(){this.div.querySelectorAll(".context-menu-item:not(.close-menu), .context-submenu").forEach((e=>e.remove())),this.items=[]}addColorPickerMenuItem(e,t,i,o){const s=document.createElement("span");s.classList.add("context-menu-item"),s.innerText=e,this.div.appendChild(s);const n=e=>{const t=le(i,e);o.applyOptions(t),console.log(`Updated ${i} to ${e}`)};return s.addEventListener("click",(e=>{e.stopPropagation(),this.colorPicker||(this.colorPicker=new ne(t??"#000000",n)),this.colorPicker.openMenu(e,225,n)})),s}currentWidthOptions=[];currentStyleOptions=[];populateSeriesMenu(e,i){const o=l(e,this.handler.legend),s=e.options();if(!s)return void console.warn("No options found for the selected series.");this.div.innerHTML="";const n=[],r=[],a=[],c=[],d=[];for(const e of Object.keys(s)){const i=s[e];if(this.shouldSkipOption(e))continue;if(e.toLowerCase().includes("base"))continue;const o=he(e).toLowerCase();if(o.includes("color"))"string"==typeof i?n.push({label:e,value:i}):console.warn(`Expected string value for color option "${e}".`);else if(o.includes("width"))"number"==typeof i?c.push({name:e,label:e,value:i}):console.warn(`Expected number value for width option "${e}".`);else if(o.includes("visible")||o.includes("visibility"))"boolean"==typeof i?r.push({label:e,value:i}):console.warn(`Expected boolean value for visibility option "${e}".`);else if("lineType"===e){const t=this.getPredefinedOptions(he(e));d.push({name:e,label:e,value:i,options:t})}else if("crosshairMarkerRadius"===e)"number"==typeof i?c.push({name:e,label:e,value:i,min:1,max:50}):console.warn(`Expected number value for crosshairMarkerRadius option "${e}".`);else if(o.includes("style"))if("string"==typeof i||Object.values(t.LineStyle).includes(i)||"number"==typeof i){const t=["Solid","Dotted","Dashed","Large Dashed","Sparse Dotted"];d.push({name:e,label:e,value:i,options:t})}else console.warn(`Expected string/number value for style-related option "${e}".`);else a.push({label:e,value:i})}this.currentWidthOptions=c,this.currentStyleOptions=d,r.length>0&&this.addMenuItem("Visibility Options ▸",(()=>{this.populateVisibilityMenu(i,e)}),!1,!0),this.currentStyleOptions.length>0&&this.addMenuItem("Style Options ▸",(()=>{this.populateStyleMenu(i,e)}),!1,!0),this.currentWidthOptions.length>0&&this.addMenuItem("Width Options ▸",(()=>{this.populateWidthMenu(i,e)}),!1,!0),n.length>0&&this.addMenuItem("Color Options ▸",(()=>{this.populateColorOptionsMenu(n,e,i)}),!1,!0),a.forEach((t=>{const i=he(t.label);if(!this.constraints[t.label]?.skip)if("boolean"==typeof t.value)this.addMenuItem(`${i} ▸`,(()=>{this.div.innerHTML="";const i=!t.value,o=le(t.label,i);e.applyOptions(o),console.log(`Toggled ${t.label} to ${i}`)}),t.value);else if("string"==typeof t.value){const o=this.getPredefinedOptions(t.label);o&&o.length>0?this.addMenuItem(`${i} ▸`,(()=>{this.div.innerHTML="",this.addSelectInput(i,t.value,o,(i=>{const o=le(t.label,i);e.applyOptions(o),console.log(`Updated ${t.label} to ${i}`)}))}),!1,!0):this.addMenuItem(`${i} ▸`,(()=>{this.div.innerHTML="",this.addTextInput(i,t.value,(i=>{const o=le(t.label,i);e.applyOptions(o),console.log(`Updated ${t.label} to ${i}`)}))}),!1,!0)}else{if("number"!=typeof t.value)return;{const o=this.constraints[t.label]?.min,s=this.constraints[t.label]?.max;this.addMenuItem(`${i} ▸`,(()=>{this.div.innerHTML="",this.addNumberInput(i,t.value,(i=>{const o=le(t.label,i);e.applyOptions(o),console.log(`Updated ${t.label} to ${i}`)}),o,s)}),!1,!0)}}})),this.addMenuItem("Fill Area Between",(()=>{this.startFillAreaBetween(i,o)}),!1,!1);const h=o.primitives;console.log("Primitives:",h);const p=h?.FillArea??h?.pt;h.FillArea&&this.addMenuItem("Customize Fill Area",(()=>{this.customizeFillAreaOptions(i,p)}),!1,!0),this.addMenuItem("⤝ Main Menu",(()=>{this.populateChartMenu(i)}),!1,!1),this.showMenu(i)}populateDrawingMenu(e,t){this.div.innerHTML="";for(const t of Object.keys(e._options)){let e;if(t.toLowerCase().includes("color"))e=new re(this.saveDrawings,t);else{if("lineStyle"!==t)continue;e=new ae(this.saveDrawings)}const i=t=>e.openMenu(t);this.menuItem(he(t),i,(()=>{document.removeEventListener("click",e.closeMenu),e._div.style.display="none"}))}this.separator(),this.menuItem("Delete Drawing",(()=>this.drawingTool.delete(e))),this.addMenuItem("⤝ Main Menu",(()=>{this.populateChartMenu(t)}),!1,!1),this.showMenu(t)}populateChartMenu(e){this.div.innerHTML="",console.log("Displaying Menu Options: Chart"),this.addResetViewOption(),this.addMenuItem("⌯ Layout Options        ",(()=>this.populateLayoutMenu(e)),!1,!0),this.addMenuItem("⌗ Grid Options          ",(()=>this.populateGridMenu(e)),!1,!0),this.addMenuItem("⊹ Crosshair Options     ",(()=>this.populateCrosshairOptionsMenu(e)),!1,!0),this.addMenuItem("ⴵ Time Scale Options    ",(()=>this.populateTimeScaleMenu(e)),!1,!0),this.addMenuItem("$ Price Scale Options   ",(()=>this.populatePriceScaleMenu(e,"right")),!1,!0),this.showMenu(e)}populateLayoutMenu(e){this.div.innerHTML="";const t="Text Color",i="layout.textColor",o=this.getCurrentOptionValue(i)||"#000000";this.addColorPickerMenuItem(he(t),o,i,this.handler.chart),this.addMenuItem("Background Options",(()=>this.populateBackgroundMenu(e)),!1,!0),this.addMenuItem("⤝ Main Menu",(()=>{this.populateChartMenu(e)}),!1,!1),this.showMenu(e)}populateWidthMenu(e,t){this.div.innerHTML="",this.currentWidthOptions.forEach((e=>{"number"==typeof e.value&&this.addNumberInput(he(e.label),e.value,(i=>{const o=le(e.name,i);t.applyOptions(o),console.log(`Updated ${e.label} to ${i}`)}),e.min,e.max)})),this.addMenuItem("⤝ Back to Series Options",(()=>{this.populateSeriesMenu(t,e)}),!1,!1),this.showMenu(e)}populateStyleMenu(e,t){this.div.innerHTML="",this.currentStyleOptions.forEach((e=>{const i=this.getPredefinedOptions(e.name);i&&this.addSelectInput(he(e.name),e.value.toString(),i,(o=>{const s=i.indexOf(o),n=le(e.name,s);t.applyOptions(n),console.log(`Updated ${e.name} to ${o}`)}))})),this.addMenuItem("⤝ Main Menu",(()=>{this.populateChartMenu(e)}),!1),this.showMenu(e)}populateLineTypeMenu(e,t,i){this.div.innerHTML="",i.options&&(this.addSelectInput(i.label,i.value.toString(),i.options,(e=>{const o="Simple"===e?0:1,s=le(i.name,o);t.applyOptions(s),console.log(`Updated ${i.label} to ${e}`)})),this.addMenuItem("⤝ Back to Style Options",(()=>{this.populateStyleMenu(e,t)}),!1),this.showMenu(e))}addTextInput(e,t,i){const o=document.createElement("div");o.classList.add("context-menu-item"),o.style.display="flex",o.style.alignItems="center",o.style.justifyContent="space-between";const s=document.createElement("label");s.innerText=e,s.htmlFor=`${e.toLowerCase()}-input`,s.style.marginRight="8px",o.appendChild(s);const n=document.createElement("input");return n.type="text",n.value=t,n.id=`${e.toLowerCase()}-input`,n.style.flex="1",n.style.marginLeft="auto",n.style.cursor="pointer",n.addEventListener("input",(e=>{const t=e.target;i(t.value)})),o.appendChild(n),this.div.appendChild(o),o}addSelectInput(e,t,i,o){const s=document.createElement("div");s.className="menu-item select-input";const n=document.createElement("span");n.innerText=e,s.appendChild(n);const r=document.createElement("select");i.forEach((e=>{const i=document.createElement("option");i.value=e,i.text=e,e===t&&(i.selected=!0),r.appendChild(i)})),r.addEventListener("change",(e=>{const t=e.target.value;o(t)})),s.appendChild(r),this.div.appendChild(s)}populateColorOptionsMenu(e,t,i){this.div.innerHTML="",e.forEach((e=>{this.addColorPickerMenuItem(he(e.label),e.value,e.label,t)})),this.addMenuItem("⤝ Back to Series Options",(()=>{this.populateSeriesMenu(t,i)}),!1,!1),this.showMenu(i)}populateVisibilityMenu(e,t){this.div.innerHTML="";const i=t.options();["visible","crosshairMarkerVisible","priceLineVisible"].forEach((e=>{const o=i[e];"boolean"==typeof o&&this.addCheckbox(he(e),o,(i=>{const o=le(e,i);t.applyOptions(o),console.log(`Toggled ${e} to ${i}`)}))})),this.addMenuItem("⤝ Back to Series Options",(()=>{this.populateSeriesMenu(t,e)}),!1,!1),this.showMenu(e)}populateBackgroundTypeMenu(e){this.div.innerHTML="";[{text:"Solid",action:()=>this.setBackgroundType(e,t.ColorType.Solid)},{text:"Vertical Gradient",action:()=>this.setBackgroundType(e,t.ColorType.VerticalGradient)}].forEach((e=>{this.addMenuItem(e.text,e.action,!1,!1,1)})),this.addMenuItem("⤝ Chart Menu",(()=>{this.populateChartMenu(e)}),!1),this.showMenu(e)}populateGradientBackgroundMenuInline(e,t){this.div.innerHTML="",this.addColorPickerMenuItem(he("Top Color"),t.topColor,"layout.background.topColor",this.handler.chart),this.addColorPickerMenuItem(he("Bottom Color"),t.bottomColor,"layout.background.bottomColor",this.handler.chart),this.addMenuItem("⤝ Background Type & Colors",(()=>{this.populateBackgroundTypeMenu(e)}),!1),this.showMenu(e)}populateGridMenu(e){this.div.innerHTML="";[{name:"Vertical Grid Color",valuePath:"grid.vertLines.color"},{name:"Horizontal Grid Color",valuePath:"grid.horzLines.color"}].forEach((e=>{const t=this.getCurrentOptionValue(e.valuePath)||"#FFFFFF";this.addColorPickerMenuItem(he(e.name),t,e.valuePath,this.handler.chart)})),this.addMenuItem("⤝ Main Menu",(()=>{this.populateChartMenu(e)}),!1),this.showMenu(e)}populateBackgroundMenu(e){this.div.innerHTML="",this.addMenuItem("Type & Colors",(()=>{this.populateBackgroundTypeMenu(e)}),!1,!0),this.addMenuItem("Options",(()=>{this.populateBackgroundOptionsMenu(e)}),!1,!0),this.addMenuItem("⤝ Layout Options",(()=>{this.populateLayoutMenu(e)}),!1),this.showMenu(e)}populateBackgroundOptionsMenu(e){this.div.innerHTML="";[{name:"Background Color",valuePath:"layout.background.color"},{name:"Background Top Color",valuePath:"layout.background.topColor"},{name:"Background Bottom Color",valuePath:"layout.background.bottomColor"}].forEach((e=>{const t=this.getCurrentOptionValue(e.valuePath)||"#FFFFFF";this.addColorPickerMenuItem(he(e.name),t,e.valuePath,this.handler.chart)})),this.addMenuItem("⤝ Background",(()=>{this.populateBackgroundMenu(e)}),!1),this.showMenu(e)}populateSolidBackgroundMenuInline(e,t){this.div.innerHTML="",this.addColorPickerMenuItem(he("Background Color"),t.color,"layout.background.color",this.handler.chart),this.addMenuItem("⤝ Type & Colors",(()=>{this.populateBackgroundTypeMenu(e)}),!1),this.showMenu(e)}populateCrosshairOptionsMenu(e){this.div.innerHTML="";[{name:"Line Color",valuePath:"crosshair.lineColor"},{name:"Vertical Line Color",valuePath:"crosshair.vertLine.color"},{name:"Horizontal Line Color",valuePath:"crosshair.horzLine.color"}].forEach((e=>{const t=this.getCurrentOptionValue(e.valuePath)||"#000000";this.addColorPickerMenuItem(he(e.name),t,e.valuePath,this.handler.chart)})),this.addMenuItem("⤝ Main Menu",(()=>{this.populateChartMenu(e)}),!1),this.showMenu(e)}populateTimeScaleMenu(e){this.div.innerHTML="";[{name:"Right Offset",type:"number",valuePath:"timeScale.rightOffset",min:0,max:100},{name:"Bar Spacing",type:"number",valuePath:"timeScale.barSpacing",min:1,max:100},{name:"Fix Left Edge",type:"boolean",valuePath:"timeScale.fixLeftEdge"},{name:"Border Color",type:"color",valuePath:"timeScale.borderColor"}].forEach((e=>{if("number"===e.type){const t=this.getCurrentOptionValue(e.valuePath);this.addNumberInput(he(e.name),t,(t=>{const i=le(e.valuePath,t);this.handler.chart.applyOptions(i),console.log(`Updated TimeScale ${e.name} to: ${t}`)}),e.min,e.max)}else if("boolean"===e.type){const t=this.getCurrentOptionValue(e.valuePath);this.addCheckbox(he(e.name),t,(t=>{const i=le(e.valuePath,t);this.handler.chart.applyOptions(i),console.log(`Updated TimeScale ${e.name} to: ${t}`)}))}else if("color"===e.type){const t=this.getCurrentOptionValue(e.valuePath)||"#000000";this.addColorPickerMenuItem(he(e.name),t,e.valuePath,this.handler.chart)}})),this.showMenu(e),this.addMenuItem("⤝ Main Menu",(()=>{this.populateChartMenu(e)}),!1)}populatePriceScaleMenu(e,t="right"){this.div.innerHTML="",this.addMenuItem("Set Price Scale Mode",(()=>{this.populatePriceScaleModeMenu(e,t)}),!0,!0,1),this.addMenuItem("⤝ Main Menu",(()=>{this.populateChartMenu(e)}),!1),this.showMenu(e)}populatePriceScaleModeMenu(e,i){this.div.innerHTML="";const o=this.handler.chart.priceScale(i).options().mode??t.PriceScaleMode.Normal;[{name:"Normal",value:t.PriceScaleMode.Normal},{name:"Logarithmic",value:t.PriceScaleMode.Logarithmic},{name:"Percentage",value:t.PriceScaleMode.Percentage},{name:"Indexed To 100",value:t.PriceScaleMode.IndexedTo100}].forEach((e=>{const t=o===e.value;this.addMenuItem(e.name,(()=>{this.applyPriceScaleOptions(i,{mode:e.value}),this.hideMenu(),console.log(`Price scale (${i}) mode set to: ${e.name}`)}),t,!1)})),this.addMenuItem("⤝ Back",(()=>{this.populatePriceScaleMenu(e,i)}),!1,!1,1),this.showMenu(e)}applyPriceScaleOptions(e,t){const i=this.handler.chart.priceScale(e);i?(i.applyOptions(t),console.log(`Applied options to price scale "${e}":`,t)):console.warn(`Price scale with ID "${e}" not found.`)}getCurrentOptionValue(e){const t=e.split(".");let i=this.handler.chart.options();for(const o of t){if(!i||!(o in i))return console.warn(`Option path "${e}" is invalid.`),null;i=i[o]}return i}mapStyleChoice(e){switch(e){case"Solid":default:return 0;case"Dotted":return 1;case"Dashed":return 2;case"Large Dashed":return 3;case"Sparse Dotted":return 4}}setBackgroundType(e,i){const o=this.handler.chart.options().layout?.background;let s;if(i===t.ColorType.Solid)s=o.type===t.ColorType.Solid?{type:t.ColorType.Solid,color:o.color}:{type:t.ColorType.Solid,color:"#FFFFFF"};else{if(i!==t.ColorType.VerticalGradient)return void console.error(`Unsupported ColorType: ${i}`);s=function(e){return e.type===t.ColorType.VerticalGradient}(o)?{type:t.ColorType.VerticalGradient,topColor:o.topColor,bottomColor:o.bottomColor}:{type:t.ColorType.VerticalGradient,topColor:"#FFFFFF",bottomColor:"#000000"}}this.handler.chart.applyOptions({layout:{background:s}}),i===t.ColorType.Solid?this.populateSolidBackgroundMenuInline(e,s):i===t.ColorType.VerticalGradient&&this.populateGradientBackgroundMenuInline(e,s)}startFillAreaBetween(e,t){console.log("Fill Area Between started. Origin series set:",t.options().title),this.populateSeriesListMenu(e,(e=>{e&&e!==t?(console.log("Destination series selected:",e.options().title),t.primitives.FillArea=new c(t,e,{...p}),t.attachPrimitive(t.primitives.FillArea,"Fill Area"),console.log("Fill Area successfully added between selected series."),alert(`Fill Area added between ${t.options().title} and ${e.options().title}`)):alert("Invalid selection. Please choose a different series as the destination.")}))}getPredefinedOptions(e){return{"Series Type":["Line","Histogram","Area","Bar","Candlestick"],"Line Style":["Solid","Dotted","Dashed","Large Dashed","Sparse Dotted"],"Line Type":["Simple","WithSteps","Curved"],seriesType:["Line","Histogram","Area","Bar","Candlestick"],lineStyle:["Solid","Dotted","Dashed","Large Dashed","Sparse Dotted"],lineType:["Simple","WithSteps","Curved"]}[he(e)]||null}populateSeriesListMenu(e,t){this.div.innerHTML="";Array.from(this.handler.seriesMap.entries()).map((([e,t])=>({label:e,value:t}))).forEach((e=>{this.addMenuItem(e.label,(()=>{t(e.value),this.hideMenu()}))})),this.addMenuItem("Cancel",(()=>{console.log("Operation canceled."),this.hideMenu()})),this.showMenu(e)}customizeFillAreaOptions(e,t){this.div.innerHTML="",this.addColorPickerMenuItem("Origin Top Color",t.options.originColor,"originColor",t),this.addColorPickerMenuItem("Destination Top Color",t.options.destinationColor,"destinationColor",t),this.addMenuItem("⤝ Back to Main Menu",(()=>this.populateChartMenu(e)),!1),this.showMenu(e)}addResetViewOption(){const e=this.addMenuItem("Reset chart view     ⟲",(()=>{this.resetView()}));this.div.appendChild(e)}}var ue;function me(e){switch(e.trim().toLowerCase()){case"rectangle":return ue.Rectangle;case"rounded":return ue.Rounded;case"ellipse":return ue.Ellipse;case"arrow":return ue.Arrow;case"3d":return ue.Cube;case"polygon":return ue.Polygon;default:return console.warn(`Unknown CandleShape: ${e}`),ue.Rectangle}}function ge(e,t){if(e.startsWith("#"))return function(e,t){if(e=e.replace(/^#/,""),!/^([0-9A-F]{3}){1,2}$/i.test(e))throw new Error("Invalid hex color format.");const[i,o,s]=(e=>3===e.length?[parseInt(e[0]+e[0],16),parseInt(e[1]+e[1],16),parseInt(e[2]+e[2],16)]:[parseInt(e.slice(0,2),16),parseInt(e.slice(2,4),16),parseInt(e.slice(4,6),16)])(e);return`rgba(${i}, ${o}, ${s}, ${t})`}(e,t);if(e.startsWith("rgba")||e.startsWith("rgb"))return e.replace(/rgba?\((\d+),\s*(\d+),\s*(\d+)(?:,\s*[\d.]+)?\)/,`rgba($1, $2, $3, ${t})`);throw new Error("Unsupported color format. Use hex, rgb, or rgba.")}function _e(e,t=.2){let[i,o,s,n=1]=e.startsWith("#")?[...(r=e,3===(r=r.replace(/^#/,"")).length?[parseInt(r[0]+r[0],16),parseInt(r[1]+r[1],16),parseInt(r[2]+r[2],16)]:[parseInt(r.slice(0,2),16),parseInt(r.slice(2,4),16),parseInt(r.slice(4,6),16)]),1]:e.match(/\d+(\.\d+)?/g).map(Number);var r;return i=Math.max(0,Math.min(255,i*(1-t))),o=Math.max(0,Math.min(255,o*(1-t))),s=Math.max(0,Math.min(255,s*(1-t))),e.startsWith("#")?`#${((1<<24)+(Math.round(i)<<16)+(Math.round(o)<<8)+Math.round(s)).toString(16).slice(1)}`:`rgba(${Math.round(i)}, ${Math.round(o)}, ${Math.round(s)}, ${n})`}function ye(e){return function(e){return Math.max(1,Math.floor(e))}(e)/e}!function(e){e.Rectangle="Rectangle",e.Rounded="Rounded",e.Ellipse="Ellipse",e.Arrow="Arrow",e.Cube="3d",e.Polygon="Polygon"}(ue||(ue={}));class ve{_options;constructor(e){this._options=e}aggregate(e,t){const i=this._options?.chandelierSize??1,o=[];for(let s=0;s<e.length;s+=i){const n=e.slice(s,s+i),r=n.length<i&&s+n.length===e.length;if(0===n.length){console.warn("Empty bucket encountered during aggregation.");continue}const a=this._chandelier(n,s,s+n.length-1,t,r);o.push(a)}return o}_chandelier(e,t,i,o,s=!1){if(0===e.length)throw new Error("Bucket cannot be empty in _chandelier method.");const n=e[0].originalData?.open??e[0].open??0,r=e[e.length-1].originalData?.close??e[e.length-1].close??0,a=o(n)??0,l=o(r)??0,c=e.map((e=>e.originalData?.high??e.high)),d=e.map((e=>e.originalData?.low??e.low)),h=c.length>0?Math.max(...c):0,p=d.length>0?Math.min(...d):0,u=o(h)??0,m=o(p)??0,g=e[0].x,_=r>n,y=_?this._options?.upColor||"rgba(0,255,0,0.333)":this._options?.downColor||"rgba(255,0,0,0.333)",v=_?this._options?.borderUpColor||ge(y,1):this._options?.borderDownColor||ge(y,1),b=_?this._options?.wickUpColor||v:this._options?.wickDownColor||v,f=e.reduce(((e,t)=>t.lineStyle??t.originalData?.lineStyle??e),this._options?.lineStyle??1),w=e.reduce(((e,t)=>t.lineWidth??t.originalData?.lineWidth??e),this._options?.lineWidth??1);return{open:a,high:u,low:m,close:l,x:g,isUp:_,startIndex:t,endIndex:i,isInProgress:s,color:y,borderColor:v,wickColor:b,shape:e.reduce(((e,t)=>(t.shape?me(t.shape):t.originalData?.shape?me(t.originalData.shape):void 0)??e),this._options?.shape??ue.Rectangle)||ue.Rectangle,lineStyle:f,lineWidth:w}}}class be{_data=null;_options=null;_aggregator=null;draw(e,t){e.useBitmapCoordinateSpace((e=>this._drawImpl(e,t)))}update(e,t){this._data=e,this._options=t,this._aggregator=new ve(t)}_drawImpl(e,t){if(!this._data||0===this._data.bars.length||!this._data.visibleRange||!this._options)return;const i=this._data.bars.map(((e,t)=>({open:e.originalData?.open??0,high:e.originalData?.high??0,low:e.originalData?.low??0,close:e.originalData?.close??0,x:e.x,shape:e.originalData?.shape??this._options?.shape??"Rectangle",lineStyle:e.originalData?.lineStyle??this._options?.lineStyle??1,lineWidth:e.originalData?.lineWidth??this._options?.lineWidth??1,isUp:(e.originalData?.close??0)>=(e.originalData?.open??0),color:this._options?.color??"rgba(0,0,0,0)",borderColor:this._options?.borderColor??"rgba(0,0,0,0)",wickColor:this._options?.wickColor??"rgba(0,0,0,0)",startIndex:t,endIndex:t}))),o=this._aggregator?.aggregate(i,t)??[],s=this._options.radius(this._data.barSpacing),{horizontalPixelRatio:n,verticalPixelRatio:r}=e,a=this._data.barSpacing*n;this._drawCandles(e,o,this._data.visibleRange,s,a,n,r),this._drawWicks(e,o,this._data.visibleRange)}_drawWicks(e,t,i){if(null===this._data||null===this._options)return;if("3d"===this._options.shape)return;const{context:o,horizontalPixelRatio:s,verticalPixelRatio:n}=e,r=this._data.barSpacing*s,a=ye(s);for(const e of t){if(e.startIndex<i.from||e.endIndex>i.to)continue;const t=e.low*n,l=e.high*n,c=Math.min(e.open,e.close)*n,d=Math.max(e.open,e.close)*n;let h=e.x*s;const p=e.endIndex-e.startIndex;p&&p>1&&(h+=r*Math.max(1,p)/2);let u=l,m=c,g=d,_=t;"Polygon"===this._options.shape&&(m=(l+c)/2,g=(t+d)/2),o.fillStyle=e.color,o.strokeStyle=e.wickColor??e.color;const y=(e,t,i,s,n)=>{o.roundRect?o.roundRect(e,t,i,s,n):o.rect(e,t,i,s)},v=m-u;v>0&&(o.beginPath(),y(h-Math.floor(a/2),u,a,v,a/2),o.fill(),o.stroke());const b=_-g;b>0&&(o.beginPath(),y(h-Math.floor(a/2),g,a,b,a/2),o.fill(),o.stroke())}}_drawCandles(e,t,i,o,s,n,r){const{context:a}=e,l=this._options?.barSpacing??.8;a.save();for(const e of t){const t=e.endIndex-e.startIndex,c=1!==this._options?.chandelierSize?s*Math.max(1,t+1)-(1-l)*s:s*l,d=e.x*n,h=s*l;if(e.startIndex<i.from||e.endIndex>i.to)continue;const p=Math.min(e.open,e.close)*r,u=Math.max(e.open,e.close)*r,m=p-u,g=(p+u)/2,_=d-h/2,y=_+c,v=_+c/2;switch(a.fillStyle=e.color??this._options?.color??"rgba(255,255,255,1)",a.strokeStyle=e.borderColor??this._options?.borderColor??e.color??"rgba(255,255,255,1)",L(a,e.lineStyle),a.lineWidth=e.lineWidth??1,e.shape){case"Rectangle":default:this._drawCandle(a,_,y,g,m);break;case"Rounded":this._drawRounded(a,_,y,g,m,o);break;case"Ellipse":this._drawEllipse(a,_,y,v,g,m);break;case"Arrow":this._drawArrow(a,_,y,v,g,m,e.high*r,e.low*r,e.isUp);break;case"3d":this._draw3d(a,d,e.high*r,e.low*r,e.open*r,e.close*r,h,c,e.color,e.borderColor,e.isUp,l);break;case"Polygon":this._drawPolygon(a,_,y,g,m,e.high*r,e.low*r,e.isUp)}}a.restore()}_drawCandle(e,t,i,o,s){const n=o-s/2,r=o+s/2;e.beginPath(),e.moveTo(t,n),e.lineTo(t,r),e.lineTo(i,r),e.lineTo(i,n),e.closePath(),e.fill(),e.stroke()}_drawRounded(e,t,i,o,s,n){const r=o-s/2,a=i-t,l=Math.abs(Math.min(n,.1*Math.min(a,s),5));e.beginPath(),e.roundRect?e.roundRect(t,r,a,s,l):e.rect(t,r,a,s),e.fill(),e.stroke()}_drawEllipse(e,t,i,o,s,n){const r=(i-t)/2,a=n/2,l=o;e.beginPath(),e.ellipse(l,s,Math.abs(r),Math.abs(a),0,0,2*Math.PI),e.fill(),e.stroke()}_draw3d(e,t,i,o,s,n,r,a,l,c,d,h){const p=-Math.max(a,1)*(1-h),u=_e(l,.666),m=_e(l,.333),g=_e(l,.2),_=t-r/2,y=t-r/2+a+p,v=_-p,b=y-p;let f,w,C,x;d?(f=s,w=o,C=i,x=n):(f=s,w=i,C=o,x=n),e.fillStyle=m,e.strokeStyle=c,e.fillStyle=g,d?(e.fillStyle=u,e.beginPath(),e.moveTo(_,w),e.lineTo(v,x),e.lineTo(b,x),e.lineTo(y,w),e.closePath(),e.fill(),e.stroke(),e.fillStyle=u,e.beginPath(),e.moveTo(_,f),e.lineTo(v,C),e.lineTo(v,x),e.lineTo(_,w),e.closePath(),e.fill(),e.stroke(),e.fillStyle=u,e.beginPath(),e.moveTo(y,f),e.lineTo(b,C),e.lineTo(b,x),e.lineTo(y,w),e.closePath(),e.fill(),e.stroke(),e.fillStyle=g,e.beginPath(),e.moveTo(_,f),e.lineTo(v,C),e.lineTo(b,C),e.lineTo(y,f),e.closePath(),e.fill(),e.stroke()):(e.fillStyle=g,e.beginPath(),e.moveTo(_,f),e.lineTo(v,C),e.lineTo(b,C),e.lineTo(y,f),e.closePath(),e.fill(),e.stroke(),e.fillStyle=m,e.beginPath(),e.moveTo(y,f),e.lineTo(b,C),e.lineTo(b,x),e.lineTo(y,w),e.closePath(),e.fill(),e.stroke(),e.fillStyle=m,e.beginPath(),e.moveTo(_,f),e.lineTo(v,C),e.lineTo(v,x),e.lineTo(_,w),e.closePath(),e.fill(),e.stroke(),e.fillStyle=m,e.beginPath(),e.moveTo(_,w),e.lineTo(v,x),e.lineTo(b,x),e.lineTo(y,w),e.closePath(),e.fill(),e.stroke())}_drawPolygon(e,t,i,o,s,n,r,a){const l=o+s/2,c=o-s/2;e.save(),e.beginPath(),a?(e.moveTo(t,l),e.lineTo(i,n),e.lineTo(i,c),e.lineTo(t,r)):(e.moveTo(t,n),e.lineTo(i,l),e.lineTo(i,r),e.lineTo(t,c)),e.closePath(),e.stroke(),e.fill(),e.restore()}_drawArrow(e,t,i,o,s,n,r,a,l){e.save(),e.beginPath(),l?(e.moveTo(t,a),e.lineTo(t,s+n/2),e.lineTo(o,r),e.lineTo(i,s+n/2),e.lineTo(i,a),e.lineTo(o,s-n/2),e.lineTo(t,a)):(e.moveTo(t,r),e.lineTo(t,s-n/2),e.lineTo(o,a),e.lineTo(i,s-n/2),e.lineTo(i,r),e.lineTo(o,s+n/2),e.lineTo(t,r)),e.closePath(),e.fill(),e.stroke(),e.restore()}}const fe={...t.customSeriesDefaultOptions,upColor:"#26a69a",downColor:"#ef5350",wickVisible:!0,borderVisible:!0,borderColor:"#378658",borderUpColor:"#26a69a",borderDownColor:"#ef5350",wickColor:"#737375",wickUpColor:"#26a69a",wickDownColor:"#ef5350",radius:function(e){return e<4?0:e/3},shape:"Rectangle",chandelierSize:1,barSpacing:.8,lineStyle:0,lineWidth:1};class we{_renderer;constructor(){this._renderer=new be}priceValueBuilder(e){return[e.high,e.low,e.close]}renderer(){return this._renderer}isWhitespace(e){return void 0===e.close}update(e,t){this._renderer.update(e,t)}defaultOptions(){return fe}}g();class Ce{id;commandFunctions=[];static handlers=new Map;seriesOriginMap=new WeakMap;wrapper;div;chart;scale;precision=2;series;volumeSeries;legend;_topBar;toolBox;spinner;_seriesList=[];seriesMap=new Map;seriesMetadata;ContextMenu;currentMouseEventParams=null;constructor(e,t,i,o,s){this.reSize=this.reSize.bind(this),this.id=e,this.scale={width:t,height:i},Ce.handlers.set(e,this),this.wrapper=document.createElement("div"),this.wrapper.classList.add("handler"),this.wrapper.style.float=o,this.div=document.createElement("div"),this.div.style.position="relative",this.wrapper.appendChild(this.div),window.containerDiv.append(this.wrapper),this.chart=this._createChart(),this.series=this.createCandlestickSeries(),this.volumeSeries=this.createVolumeSeries(),this.series.applyOptions,this.legend=new f(this),this.chart.subscribeCrosshairMove((e=>{this.currentMouseEventParams=e,window.MouseEventParams=e})),document.addEventListener("keydown",(e=>{for(let t=0;t<this.commandFunctions.length&&!this.commandFunctions[t](e);t++);})),window.handlerInFocus=this.id,this.wrapper.addEventListener("mouseover",(()=>{window.handlerInFocus=this.id,window.MouseEventParams=this.currentMouseEventParams||null})),this.seriesMetadata=new WeakMap,this.reSize(),s&&(window.addEventListener("resize",(()=>this.reSize())),this.chart.subscribeCrosshairMove((e=>{this.currentMouseEventParams=e})),this.ContextMenu=new pe(this,Ce.handlers,(()=>window.MouseEventParams??null)))}reSize(){let e=0!==this.scale.height&&this._topBar?._div.offsetHeight||0;this.chart.resize(window.innerWidth*this.scale.width,window.innerHeight*this.scale.height-e),this.wrapper.style.width=100*this.scale.width+"%",this.wrapper.style.height=100*this.scale.height+"%",0===this.scale.height||0===this.scale.width?this.toolBox&&(this.toolBox.div.style.display="none"):this.toolBox&&(this.toolBox.div.style.display="flex")}primitives=new Map;_createChart(){return t.createChart(this.div,{width:window.innerWidth*this.scale.width,height:window.innerHeight*this.scale.height,layout:{textColor:window.pane.color,background:{color:"#000000",type:t.ColorType.Solid},fontSize:12},rightPriceScale:{scaleMargins:{top:.3,bottom:.25}},timeScale:{timeVisible:!0,secondsVisible:!1},crosshair:{mode:t.CrosshairMode.Normal,vertLine:{labelBackgroundColor:"rgb(46, 46, 46)"},horzLine:{labelBackgroundColor:"rgb(55, 55, 55)"}},grid:{vertLines:{color:"rgba(29, 30, 38, 5)"},horzLines:{color:"rgba(29, 30, 58, 5)"}},handleScroll:{vertTouchDrag:!0}})}createCandlestickSeries(){const e="rgba(39, 157, 130, 100)",t="rgba(200, 97, 100, 100)",i=this.chart.addCandlestickSeries({upColor:e,borderUpColor:e,wickUpColor:e,downColor:t,borderDownColor:t,wickDownColor:t});i.priceScale().applyOptions({scaleMargins:{top:.2,bottom:.2}});const o=r(i,this.legend);return o.applyOptions({title:"candles"}),o}createVolumeSeries(){const e=this.chart.addHistogramSeries({color:"#26a69a",priceFormat:{type:"volume"},priceScaleId:"volume_scale"});e.priceScale().applyOptions({scaleMargins:{top:.8,bottom:0}});const t=r(e,this.legend);return t.applyOptions({title:"Volume"}),t}createLineSeries(e,t){const{group:i,legendSymbol:o="▨",...s}=t,n=r(this.chart.addLineSeries(s),this.legend);n.applyOptions({title:e}),this._seriesList.push(n),this.seriesMap.set(e,n);const a=n.options().color||"rgba(255,0,0,1)",l={name:e,series:n,colors:[a.startsWith("rgba")?a.replace(/[^,]+(?=\))/,"1"):a],legendSymbol:Array.isArray(o)?o:o?[o]:[],seriesType:"Line",group:i};return this.legend.addLegendItem(l),{name:e,series:n}}createHistogramSeries(e,t){const{group:i,legendSymbol:o="▨",...s}=t,n=r(this.chart.addHistogramSeries(s),this.legend);n.applyOptions({title:e}),this._seriesList.push(n),this.seriesMap.set(e,n);const a=n.options().color||"rgba(255,0,0,1)",l={name:e,series:n,colors:[a.startsWith("rgba")?a.replace(/[^,]+(?=\))/,"1"):a],legendSymbol:Array.isArray(o)?o:[o],seriesType:"Histogram",group:i};return this.legend.addLegendItem(l),{name:e,series:n}}createAreaSeries(e,t){const{group:i,legendSymbol:o="▨",...s}=t,n=r(this.chart.addAreaSeries(s),this.legend);this._seriesList.push(n),this.seriesMap.set(e,n);const a=n.options().lineColor||"rgba(255,0,0,1)",l={name:e,series:n,colors:[a.startsWith("rgba")?a.replace(/[^,]+(?=\))/,"1"):a],legendSymbol:Array.isArray(o)?o:o?[o]:[],seriesType:"Area",group:i};return this.legend.addLegendItem(l),{name:e,series:n}}createBarSeries(e,t){const{group:i,legendSymbol:o=["▨","▨"],...s}=t,n=this.chart.addBarSeries(s),a=r(n,this.legend);a.applyOptions({title:e}),this._seriesList.push(a),this.seriesMap.set(e,a);const l=a.options().upColor||"rgba(0,255,0,1)",c=a.options().downColor||"rgba(255,0,0,1)",d={name:e,series:a,colors:[l,c],legendSymbol:Array.isArray(o)?o:o?[o]:[],seriesType:"Bar",group:i};return this.legend.addLegendItem(d),{name:e,series:n}}createCustomOHLCSeries(e,t={}){const i="ohlc",o={...fe,...t,seriesType:i},{group:s,legendSymbol:n=["⑃","⑂"],chandelierSize:a=1,...l}=o,c=new we,d=this.chart.addCustomSeries(c,{...l,chandelierSize:a}),h=r(d,this.legend);this._seriesList.push(h),this.seriesMap.set(e,h);const p={name:e,series:h,colors:[o.borderUpColor||o.upColor,o.borderDownColor||o.downColor],legendSymbol:a>1?n.map((e=>`${e} (${a})`)):n,seriesType:i,group:s};return this.legend.addLegendItem(p),{name:e,series:d}}createFillArea(e,t,i,o,s){const n=this._seriesList.find((e=>e.options()?.title===t)),r=this._seriesList.find((e=>e.options()?.title===i));if(!n)return void console.warn(`Origin series with title "${t}" not found.`);if(!r)return void console.warn(`Destination series with title "${i}" not found.`);const a=l(n,this.legend),d=new c(n,r,{originColor:o||null,destinationColor:s||null,lineWidth:null});return a.attachPrimitive(d,e),d}attachPrimitive(e,t,i,o){let s=i;try{if(o&&!i&&(s=this.seriesMap.get(o)),!s)return void console.warn(`Series with the name "${o}" not found.`);const n=l(s,this.legend);let r;if("Tooltip"!==t)return void console.warn(`Unknown primitive type: ${t}`);r=new se({lineColor:e}),n.attachPrimitive(r,"Tooltip"),this.primitives.set(s,r)}catch(e){console.error(`Failed to attach ${t}:`,e)}}removeSeries(e){const t=this.seriesMap.get(e);t&&(this.chart.removeSeries(t),this._seriesList=this._seriesList.filter((e=>e!==t)),this.seriesMap.delete(e),this.legend.deleteLegendEntry(e),console.log(`Series "${e}" removed.`))}createToolBox(){this.toolBox=new q(this,this.id,this.chart,this.series,this.commandFunctions),this.div.appendChild(this.toolBox.div)}createTopBar(){return this._topBar=new X(this),this.wrapper.prepend(this._topBar._div),this._topBar}toJSON(){const{chart:e,...t}=this;return t}extractSeriesData(e){const t=e.data();return Array.isArray(t)?t.map((e=>[e.time,e.value||e.close||0])):(console.warn("Failed to extract data: series data is not in array format."),[])}static syncCharts(e,t,i=!1){function o(e,t){t?(e.chart.setCrosshairPosition(t.value||t.close,t.time,e.series),e.legend.legendHandler(t,!0)):e.chart.clearCrosshairPosition()}function s(e,t){return t.time&&t.seriesData.get(e)||null}const n=e.chart.timeScale(),r=t.chart.timeScale(),a=e=>{e&&n.setVisibleLogicalRange(e)},l=e=>{e&&r.setVisibleLogicalRange(e)},c=i=>{o(t,s(e.series,i))},d=i=>{o(e,s(t.series,i))};let h=t;function p(e,t,o,s,n,r){e.wrapper.addEventListener("mouseover",(()=>{h!==e&&(h=e,t.chart.unsubscribeCrosshairMove(o),e.chart.subscribeCrosshairMove(s),i||(t.chart.timeScale().unsubscribeVisibleLogicalRangeChange(n),e.chart.timeScale().subscribeVisibleLogicalRangeChange(r)))}))}p(t,e,c,d,l,a),p(e,t,d,c,a,l),t.chart.subscribeCrosshairMove(d);const u=r.getVisibleLogicalRange();u&&n.setVisibleLogicalRange(u),i||t.chart.timeScale().subscribeVisibleLogicalRangeChange(a)}static makeSearchBox(e){const t=document.createElement("div");t.classList.add("searchbox"),t.style.display="none";const i=document.createElement("div");i.innerHTML='<svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" width="24px" height="24px" viewBox="0 0 24 24" version="1.1"><path style="fill:none;stroke-width:2;stroke-linecap:round;stroke-linejoin:round;stroke:lightgray;stroke-opacity:1;stroke-miterlimit:4;" d="M 15 15 L 21 21 M 10 17 C 6.132812 17 3 13.867188 3 10 C 3 6.132812 6.132812 3 10 3 C 13.867188 3 17 6.132812 17 10 C 17 13.867188 13.867188 17 10 17 Z M 10 17 "/></svg>';const o=document.createElement("input");return o.type="text",t.appendChild(i),t.appendChild(o),e.div.appendChild(t),e.commandFunctions.push((i=>window.handlerInFocus===e.id&&!window.textBoxFocused&&("none"===t.style.display?!!/^[a-zA-Z0-9]$/.test(i.key)&&(t.style.display="flex",o.focus(),!0):("Enter"===i.key||"Escape"===i.key)&&("Enter"===i.key&&window.callbackFunction(`search${e.id}_~_${o.value}`),t.style.display="none",o.value="",!0)))),o.addEventListener("input",(()=>o.value=o.value.toUpperCase())),{window:t,box:o}}static makeSpinner(e){e.spinner=document.createElement("div"),e.spinner.classList.add("spinner"),e.wrapper.appendChild(e.spinner);let t=0;!function i(){e.spinner&&(t+=10,e.spinner.style.transform=`translate(-50%, -50%) rotate(${t}deg)`,requestAnimationFrame(i))}()}static _styleMap={"--bg-color":"backgroundColor","--hover-bg-color":"hoverBackgroundColor","--click-bg-color":"clickBackgroundColor","--active-bg-color":"activeBackgroundColor","--muted-bg-color":"mutedBackgroundColor","--border-color":"borderColor","--color":"color","--active-color":"activeColor"};static setRootStyles(e){const t=document.documentElement.style;for(const[i,o]of Object.entries(this._styleMap))t.setProperty(i,e[o])}}return e.Box=V,e.FillArea=c,e.Handler=Ce,e.HorizontalLine=P,e.Legend=f,e.RayLine=H,e.Table=class{_div;callbackName;borderColor;borderWidth;table;rows={};headings;widths;alignments;footer;header;constructor(e,t,i,o,s,n,r=!1,a,l,c,d,h){this._div=document.createElement("div"),this.callbackName=null,this.borderColor=l,this.borderWidth=c,r?(this._div.style.position="absolute",this._div.style.cursor="move"):(this._div.style.position="relative",this._div.style.float=n),this._div.style.zIndex="2000",this.reSize(e,t),this._div.style.display="flex",this._div.style.flexDirection="column",this._div.style.borderRadius="5px",this._div.style.color="white",this._div.style.fontSize="12px",this._div.style.fontVariantNumeric="tabular-nums",this.table=document.createElement("table"),this.table.style.width="100%",this.table.style.borderCollapse="collapse",this._div.style.overflow="hidden",this.headings=i,this.widths=o.map((e=>100*e+"%")),this.alignments=s;let p=this.table.createTHead().insertRow();for(let e=0;e<this.headings.length;e++){let t=document.createElement("th");t.textContent=this.headings[e],t.style.width=this.widths[e],t.style.letterSpacing="0.03rem",t.style.padding="0.2rem 0px",t.style.fontWeight="500",t.style.textAlign="center",0!==e&&(t.style.borderLeft=c+"px solid "+l),t.style.position="sticky",t.style.top="0",t.style.backgroundColor=h.length>0?h[e]:a,t.style.color=d[e],p.appendChild(t)}let u,m,g=document.createElement("div");if(g.style.overflowY="auto",g.style.overflowX="hidden",g.style.backgroundColor=a,g.appendChild(this.table),this._div.appendChild(g),window.containerDiv.appendChild(this._div),!r)return;let _=e=>{this._div.style.left=e.clientX-u+"px",this._div.style.top=e.clientY-m+"px"},y=()=>{document.removeEventListener("mousemove",_),document.removeEventListener("mouseup",y)};this._div.addEventListener("mousedown",(e=>{u=e.clientX-this._div.offsetLeft,m=e.clientY-this._div.offsetTop,document.addEventListener("mousemove",_),document.addEventListener("mouseup",y)}))}divToButton(e,t){e.addEventListener("mouseover",(()=>e.style.backgroundColor="rgba(60, 60, 60, 0.6)")),e.addEventListener("mouseout",(()=>e.style.backgroundColor="transparent")),e.addEventListener("mousedown",(()=>e.style.backgroundColor="rgba(60, 60, 60)")),e.addEventListener("click",(()=>window.callbackFunction(t))),e.addEventListener("mouseup",(()=>e.style.backgroundColor="rgba(60, 60, 60, 0.6)"))}newRow(e,t=!1){let i=this.table.insertRow();i.style.cursor="default";for(let o=0;o<this.headings.length;o++){let s=i.insertCell();s.style.width=this.widths[o],s.style.textAlign=this.alignments[o],s.style.border=this.borderWidth+"px solid "+this.borderColor,t&&this.divToButton(s,`${this.callbackName}_~_${e};;;${this.headings[o]}`)}t||this.divToButton(i,`${this.callbackName}_~_${e}`),this.rows[e]=i}deleteRow(e){this.table.deleteRow(this.rows[e].rowIndex),delete this.rows[e]}clearRows(){let e=Object.keys(this.rows).length;for(let t=0;t<e;t++)this.table.deleteRow(-1);this.rows={}}_getCell(e,t){return this.rows[e].cells[this.headings.indexOf(t)]}updateCell(e,t,i){this._getCell(e,t).textContent=i}styleCell(e,t,i,o){this._getCell(e,t).style[i]=o}makeSection(e,t,i,o=!1){let s=document.createElement("div");s.style.display="flex",s.style.width="100%",s.style.padding="3px 0px",s.style.backgroundColor="rgb(30, 30, 30)","footer"===t?this._div.appendChild(s):this._div.prepend(s);const n=[];for(let t=0;t<i;t++){let i=document.createElement("div");s.appendChild(i),i.style.flex="1",i.style.textAlign="center",o&&(this.divToButton(i,`${e}_~_${t}`),i.style.borderRadius="2px"),n.push(i)}"footer"===t?this.footer=n:this.header=n}reSize(e,t){this._div.style.width=e<=1?100*e+"%":e+"px",this._div.style.height=t<=1?100*t+"%":t+"px"}},e.ToolBox=q,e.TooltipPrimitive=se,e.TopBar=X,e.TrendLine=B,e.VerticalLine=j,e.closedEye=y,e.defaultFillAreaOptions=p,e.globalParamInit=g,e.ohlcSeries=we,e.ohlcdefaultOptions=fe,e.openEye=_,e.paneStyleDefault=m,e.setCursor=e=>{e&&(window.cursor=e),document.body.style.cursor=window.cursor},e}({},LightweightCharts);
